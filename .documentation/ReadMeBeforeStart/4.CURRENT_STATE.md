# EcoSphere Project - Current Implementation State

**Document Purpose**: Provide accurate status of actual implementation vs original planning documents
**Last Updated**: 2026-01-02 (Timezone handling documented, defensive programming approach added)
**Current Phase**: Phase 3 - Small System Prototype
**Target Reader**: AI Assistants and Project Team

---

## 1. Current Status Summary

The EcoSphere project has completed all P0 (Priority 0) core functionalities including Login, User Management, and Carbon Footprint Tracking modules, as well as P1 Electricity Dashboard. Additionally, a complete Thermal Dashboard has been implemented ahead of schedule. The project currently uses SQL Server for Thermal and Electricity modules, while other modules use Mock JSON data. The authentication system uses simple session-based approach instead of JWT, and the architecture follows React Hooks and modular patterns rather than traditional OOP class structures defined in planning documents.

**Overall Progress**: P0 100% Complete | P1 100% Complete | P2 33% Complete (Thermal only)

---

## 2. Implementation Progress Overview

| Priority | Module                    | Original Plan         | Actual Status                      | Completion | Notes                    |
| -------- | ------------------------- | --------------------- | ---------------------------------- | ---------- | ------------------------ |
| P0       | Login Module              | Basic authentication  | Session-based auth with login logs | 100%       | Simplified for prototype |
| P0       | User Management           | Admin CRUD operations | Full CRUD with permissions         | 100%       | Complete                 |
| P0       | Carbon Footprint Tracking | Two calculation modes | Two modes + 3 views + export       | 100%       | Enhanced with export     |
| P1       | Electricity Dashboard     | Basic data display    | FULLY IMPLEMENTED                  | 100%       | Complete with 3 tabs     |
| P2       | Water Dashboard           | Basic data display    | Not Started                        | 0%         | Future                   |
| P2       | Thermal Dashboard         | Skeleton only         | FULLY IMPLEMENTED                  | 100%       | Ahead of schedule        |
| P2       | 3D Visualization          | Skeleton only         | Not Started                        | 0%         | Future                   |
| P2       | Forecast/Prediction       | Skeleton only         | Not Started                        | 0%         | Future                   |
| P2       | AI Chatbot (EVA)          | Skeleton only         | Not Started                        | 0%         | Future                   |
| P2       | Quiz System               | Skeleton only         | Not Started                        | 0%         | Future                   |

---

## 3. Technology Stack: Planned vs Actual

| Component                    | Original Plan    | Actually Implemented                  | Reason for Difference          |
| ---------------------------- | ---------------- | ------------------------------------- | ------------------------------ |
| **Frontend Framework** | React 18.x       | React 19.2.0                          | Used latest stable version     |
| **Build Tool**         | Vite             | Vite 7.2.4                            | As planned                     |
| **UI Library**         | Material-UI 5.x  | Material-UI 7.3.5                     | Used latest version            |
| **State Management**   | Context API      | Context API                           | As planned                     |
| **Charts**             | Chart.js         | Chart.js 4.5.1 + react-chartjs-2      | As planned                     |
| **Routing**            | React Router 6.x | React Router 7.9.6                    | Used latest version            |
| **Date Handling**      | Not specified    | date-fns 4.1.0                        | Added for date operations      |
| **PDF Export**         | Not specified    | jsPDF 3.0.4 + html2canvas 1.4.1       | Added for export feature       |
| **Backend Framework**  | Express 4.x      | Express 5.1.0                         | Used latest version            |
| **Authentication**     | JWT Token        | Session-based (sessionStorage)        | Simplified for prototype phase |
| **Password Security**  | bcrypt hashing   | Plain text comparison                 | Deferred to final phase        |
| **Database**           | SQL Server       | Mock JSON + SQL Server (Thermal only) | Gradual migration strategy     |
| **ORM**                | Sequelize/Prisma | None (direct queries)                 | Not needed for current phase   |
| **Firebase**           | Not in plan      | Partially installed (not active)      | Prepared but not implemented   |

---

## 4. Data Source Status

| Module           | Planned Source | Current Source               | Migration Status | Notes                                     |
| ---------------- | -------------- | ---------------------------- | ---------------- | ----------------------------------------- |
| Thermal          | SQL Server     | SQL Server                   | ‚úÖ COMPLETED     | Using sqlcmdQuery.js                      |
| Electricity      | SQL Server     | SQL Server                   | ‚úÖ COMPLETED     | Using optimized hourly aggregation        |
| Carbon Footprint | SQL Server     | Mock JSON (electricity.json) | üîÑ PENDING       | Calculates from electricity data          |
| Water            | SQL Server     | Not Implemented              | ‚è∏Ô∏è NOT STARTED   | Module not built yet                      |
| Users            | SQL Server     | Mock JSON (users.json)       | üìã PLANNED       | 3 test users                              |
| Login Logs       | SQL Server     | Mock JSON (loginLogs.json)   | üìã PLANNED       | Tracks login/logout                       |

**Database Location**: `C:\XW\SAIT\GB\`
- `TestSlimDB.mdf` - Main database file
- `TestSlimDB_log.ldf` - Log file

**Database Location**: `C:\XW\SAIT\GB\`
- `TestSlimDB.mdf` - Main database file
- `TestSlimDB_log.ldf` - Log file

**Backend .env Configuration**:
```
DB_SERVER=.\SQLEXPRESS
DB_DATABASE=TestSlimDB
# Windows Authentication (no username/password needed)
```

**Important Notes**:
- Use `.\SQLEXPRESS` (not `localhost`) for SQL Server instance name
- sqlcmd requires `-C` flag to trust server certificate (ODBC Driver 18)
- Database configuration centralized in `config/database.js`

**Migration Strategy**: One module at a time, starting with Thermal as pilot implementation.

### 4.1 Electricity Database Analysis (Completed 2025-12-23)

A comprehensive analysis of GBTAC's electricity database tables has been completed. The analysis identified 21 tables in the TestSlimDB database (SaitSolarLab_* schema) and classified them by usability and purpose.

**Table Status Summary**:
- ‚úÖ USABLE - Primary (Long-term Data): 3 tables (TL341, TL340, TL339)
- ‚ö†Ô∏è USABLE - Secondary (Limited/Cumulative): 15 tables
- üìä USABLE - Historical Only: 1 table (TL3 - replaced by TL340)
- ‚ùå UNUSABLE - Invalid Data: 2 tables (TL208, TL388)

**Key Findings**:

1. **Primary Data Sources (594 days: 2019-03-25 ‚Üí 2020-11-08)**:
   - TL341: Consumption Hourly Increment (634 days including 40 extra days)
   - TL340: Generation Hourly Increment (634 days including 40 extra days)
   - TL339: Net Energy Hourly Increment (634 days including 40 extra days)
   - These three tables provide the most reliable long-term historical data

2. **Table Relationships Verified**:
   - TL337 (Cumulative) = base + sum(TL341) - Consumption tracking
   - TL336 (Cumulative) = base + sum(TL340) - Generation tracking
   - TL338 (Cumulative) = base + sum(TL339) - Net Energy tracking
   - TL342 = TL343 + TL344 + TL345 - Three-phase power breakdown

3. **Data Classification Structure**:
   - **Consumption**: Overall measurement (TL337/TL341), By phase (TL342-345), By equipment (TL208-213, TL4)
   - **Generation**: Overall measurement (TL336/TL340), By source (TL252-253), Historical (TL3)
   - **Net Energy**: Overall measurement (TL338/TL339), Alternative (TL335)

4. **Recommended Tables for Dashboard Implementation**:
   - Long-term analysis: TL341 (consumption), TL340 (generation), TL339 (net energy)
   - Recent detailed analysis: TL342-345 (three-phase breakdown, 7 days only)
   - Equipment breakdown: TL213, TL4 (2020 data), TL209-212 (2019 data)

**Documentation**: Complete analysis available in `.documentation/ReadMeBeforeStart/electricity/ELECTRICITY_TABLES_ANALYSIS_EN.md` and `ELECTRICITY_TABLES_ANALYSIS_CN.md`

**Next Steps**: 
- ‚úÖ COMPLETED: Electricity Dashboard implemented with SQL Server integration
- Integrate carbon footprint calculation with TL341 consumption data
- Consider implementing Water Dashboard next

---

## 5. Completed Features (P0 - 100%)

### 5.1 Login Module

**Planned**: Basic user authentication with JWT tokens

**Actually Implemented**:

- Simple email/password authentication
- Session management using sessionStorage
- Login log tracking with IP address
- Automatic 30-minute session timeout
- Role-based redirect (Admin to /users, TeamMember to /dashboard)

**Key Implementation Files**:

- Frontend: `LoginPage.jsx`, `AuthContext.jsx`, `useAuth.js`
- Backend: `userRoutes.js`, `userController.js`, `userService.js`
- Service: `LoginLogService.js`

**Test Accounts**:

- Super Admin: super.admin@edu.sait.ca / abcd1234
- Admin: xujun.wang@edu.sait.ca / abcd1234
- Team Member: test.member@edu.sait.ca / abcd1234

---

### 5.2 User Management Module

**Planned**: Admin can add/edit/delete users with role assignment

**Actually Implemented**:

- Full CRUD operations for users
- Three roles: SuperAdmin, Admin, TeamMember
- Five permission types: electricity, water, thermal, 3d-model, carbon-footprint
- Permission-based sidebar filtering
- Cannot delete self or SuperAdmin
- Form validation and error handling

**Key Implementation Files**:

- Frontend: `UserManagementPage.jsx`, `UserTable.jsx`, `UserTableRow.jsx`, `UserDialog.jsx`, `UserForm.jsx`
- Backend: `userRoutes.js`, `userController.js`, `userService.js`
- Services: `UserService.js`

**Features**:

- View all users in table format
- Add new user with role and permissions
- Edit existing user information
- Delete user (with restrictions)
- Real-time permission updates

---

### 5.3 Carbon Footprint Tracking Module

**Planned**: Two calculation modes with basic visualization

**Actually Implemented**:

- **Mode 1: Automatic Calculation from Mock Data**

  - Reads from electricity.json (hourly data)
  - Integrates Electricity Maps API for real-time carbon intensity
  - Three views: Real-time (today), Daily (date range), Long-term (3 months)
  - Automatic CO2 calculation: Energy (kWh) √ó Carbon Intensity (kg CO2/kWh)
- **Mode 2: Custom Calculator (User Upload)**

  - User inputs electricity bills (year, month, usage)
  - Real-time calculation without persistence
  - Dynamic add/remove bill entries
  - Data validation (no duplicates, no future dates)
  - Auto-sort by year and month
- **Visualization**:

  - Chart.js dual-line chart (Carbon Footprint + Electricity Consumption)
  - Dual Y-axis (left: kg CO2, right: kWh)
  - SAIT color scheme (red + blue)
  - Responsive design
- **Export Feature**:

  - PDF export with jsPDF + html2canvas
  - Export dialog component

**Key Implementation Files**:

- Frontend: `CarbonFootprintPage.jsx`, `CustomCalculator.jsx`, `ExportReportDialog.jsx`
- Services: `ElectricityService.js`, `ElectricityMapsService.js`
- Backend: `electricityRoutes.js`, `electricityController.js`, `electricityService.js`

**External API Integration**:

- Electricity Maps API (Alberta, CA-AB zone)
- API key managed in .env file
- 1-hour cache to reduce API calls
- Fallback carbon intensity: 0.65 kg CO2/kWh

---

### 5.4 Electricity Report Module

**Planned**: P1 priority, basic data display with charts

**Actually Implemented**: Complete electricity dashboard with three tabs and comprehensive data visualization

**Features**:

- **Three Main Tabs**:
  - Consumption: Overall consumption + Phase breakdown + Equipment breakdown
  - Generation: Overall generation + Solar source breakdown (Carport vs Rooftop)
  - Net Energy: Net energy analysis with sign preservation (negative = consumer, positive = producer)

- **Consumption Tab**:
  - Overall trend chart (hourly data)
  - Key metrics cards (Total, Average, Peak, Min)
  - Breakdown selector (Overall, By Phase, By Equipment)
  - Phase breakdown: 3-phase power analysis (Phase A, B, C + Total)
  - Equipment breakdown: 5 categories (Panel2A-1, Ventilation, Lighting, Equipment, Appliances)
  - Data source: TL341 (overall), TL342-345 (phase), TL213/TL4/TL209-212 (equipment)

- **Generation Tab**:
  - Overall trend chart (hourly data)
  - Key metrics cards (Total, Average, Peak, Min)
  - Breakdown selector (Overall, By Solar Source)
  - Solar source breakdown: Pie chart showing Carport vs Rooftop distribution
  - Data source: TL340 (overall), TL252-253 (solar source)

- **Net Energy Tab**:
  - Overall trend chart with sign preservation (shows negative and positive values)
  - Key metrics cards with color coding (red for negative, green for positive)
  - Status indicators (Net Consumer vs Net Producer)
  - Peak Surplus and Peak Deficit metrics
  - Explanatory info cards
  - Data source: TL339

- **Performance Optimization**:
  - Hourly aggregation for all breakdown data (consistent intervals)
  - Optimized SQL queries using DATEPART for 270x faster performance (35s ‚Üí 130ms)
  - Auto-load data when switching tabs
  - Date range filter with validation

- **Data Visualization**:
  - Chart.js line charts for trends
  - Chart.js pie chart for solar source breakdown
  - Dual-axis support for phase/equipment comparisons
  - Interactive legends and tooltips
  - SAIT color scheme (Red #DA291C, Blue #005EB8, Purple #9C27B0)

- **Export Feature**:
  - PDF export for each tab (Consumption, Generation, Net Energy)
  - Uses common ExportReportDialog component
  - Exports current tab view with all charts and metrics
  - SAIT branding and timestamp included
  - Preview and download options available

**Key Implementation Files**:

- Frontend Pages: `ElectricityReportPage.jsx`
- Frontend Components: 
  - Shared: `ElectricityTimeFilter.jsx`, `MetricsCards.jsx`, `OverallTrendChart.jsx`, `BreakdownSelector.jsx`
  - Consumption: `ConsumptionTab.jsx`, `PhaseBreakdownChart.jsx`, `EquipmentBreakdownChart.jsx`
  - Generation: `GenerationTab.jsx`, `SolarSourceBreakdownChart.jsx`
  - Net Energy: `NetEnergyTab.jsx`, `NetEnergyMetricsCards.jsx`
- Custom Hooks: `useElectricityData.js`
- Backend: `electricityRoutes.js`, `electricityController.js`, `electricityService.js`

**Database Tables Used**:

- Primary (634 days: 2019-02-13 to 2020-11-08):
  - TL341: Consumption Hourly Increment
  - TL340: Generation Hourly Increment
  - TL339: Net Energy Hourly Increment
- Secondary (7 days: 2020-11-01 to 2020-11-08):
  - TL342-345: Three-phase breakdown (1-min intervals, aggregated to hourly)
  - TL252-253: Solar source breakdown (1-min intervals, aggregated to hourly)
- Equipment (various date ranges):
  - TL213: Panel2A-1 (9 months: 2020-02-15 to 2020-11-08)
  - TL4: Ventilation (7 days: 2020-11-01 to 2020-11-08)
  - TL209-212: Lighting, Equipment, Appliances (7 days: 2019-11-07 to 2019-11-14)

**Technical Highlights**:

- SQL Server integration with optimized queries
- Hourly aggregation strategy for consistent performance
- Sign preservation for Net Energy (critical for understanding grid dependency)
- Component reusability (OverallTrendChart used across all tabs)
- Enterprise React standards (components <150 lines, Hooks at top)

---

## 6. Additional Features (Not in Original P0 Plan)

### 6.1 Thermal Dashboard (Fully Implemented)

**Original Plan**: P2 priority, skeleton implementation only

**Actually Implemented**: Complete functional thermal dashboard ahead of schedule

**Features**:

- **Two View Modes**:

  - Single Day: Hourly data for selected date
  - Multiple Days: Aggregated data for date range
- **Floor Selection**: Basement, First Floor, Second Floor
- **Data Visualization**:

  - Line chart showing temperature trends
  - Interactive time/date selection
  - Click on chart to jump to specific time
- **Floor Plan Heat Map**:

  - Real-time temperature overlay on floor plan
  - Color-coded temperature zones
  - Multiple sensor support (3 sensors per floor)
- **Time Control**:

  - Time slider (0-95 for 15-minute intervals)
  - Play/pause animation
  - Manual time selection
- **Data Source**: SQL Server (using sqlcmdQuery.js)
- **Export Feature**: PDF export capability

**Key Implementation Files**:

- Frontend: `ThermalPage.jsx`, `ThermalControlPanel.jsx`, `ThermalChartSection.jsx`, `ThermalFloorPlan.jsx`, `ThermalTimeSlider.jsx`
- Custom Hooks: `useThermalData.js`, `useFloorManagement.js`, `useTimeControl.js`
- Services: `ThermalService.js`
- Backend: `thermalRoutes.js`, `thermalController.js`, `thermalService.js`

**Why Implemented Early**: Served as pilot for SQL Server integration

---

### 6.2 Login Log Tracking

**Original Plan**: Basic history logs

**Actually Implemented**: Detailed login/logout tracking

**Features**:

- Records login timestamp
- Captures IP address
- Tracks logout timestamp
- Records user role and email
- Success/failure status

**Key Implementation Files**:

- Backend: `loginLogRoutes.js`, `loginLogController.js`, `loginLogService.js`
- Frontend: `LoginLogService.js`

---

### 6.3 Export Report Functionality

**Original Plan**: P2 priority

**Actually Implemented**: Working export for Carbon Footprint, Thermal, and Electricity modules

**Features**:

- PDF generation using jsPDF
- Screenshot capture using html2canvas
- Export dialog component (reusable)
- Configurable export options
- Preview before download
- SAIT branding and timestamps

**Module-Specific Implementation**:

- **Carbon Footprint**: Custom export dialog with chart capture
- **Thermal**: Uses common ExportReportDialog, exports current view
- **Electricity**: Uses common ExportReportDialog, exports current tab (Consumption/Generation/Net Energy)

**Key Implementation Files**:

- Frontend: `ExportReportDialog.jsx` (Common), `ExportReportDialog.jsx` (CarbonFootprint)
- Integration: `ThermalPage.jsx`, `ElectricityReportPage.jsx`, `CarbonFootprintPage.jsx`

---

## 7. Pending Features

### 7.1 Priority 1 (P1)

| Feature               | Status    | Notes                                 |
| --------------------- | --------- | ------------------------------------- |
| Electricity Dashboard | COMPLETED | All 3 tabs implemented with SQL Server |

### 7.2 Priority 2 (P2)

| Feature                     | Status      | Notes                                  |
| --------------------------- | ----------- | -------------------------------------- |
| Water Dashboard             | Not Started | Requires SQL Server data structure     |
| 3D Thermal Visualization    | Not Started | Requires Three.js integration          |
| Forecast/Prediction Models  | Not Started | Requires algorithm implementation      |
| Period Comparison (YoY/PoP) | Not Started | Requires historical data analysis      |
| AI Chatbot (EVA)            | Not Started | Requires Google Gemini API integration |
| Quiz System                 | Not Started | Requires QR code generation            |
| Dashboard Management        | Not Started | Admin configuration interface          |

---

## 8. Key Differences from Original Plan

### 8.1 Architecture Approach

| Aspect           | Planned                                            | Actual                               | Reason                                        |
| ---------------- | -------------------------------------------------- | ------------------------------------ | --------------------------------------------- |
| Code Structure   | Class-based OOP (following class diagram)          | Functional with Hooks and Services   | React ecosystem favors functional programming |
| Model Layer      | Separate Model classes (User, Admin, Report, etc.) | Service layer with utility functions | Simpler and more maintainable for React       |
| State Management | Redux or Context API                               | Context API only                     | Project size doesn't require Redux complexity |

### 8.2 Data Strategy

| Aspect      | Planned                        | Actual                            | Reason                                |
| ----------- | ------------------------------ | --------------------------------- | ------------------------------------- |
| Database    | Immediate SQL Server migration | Gradual migration (Thermal first) | Risk mitigation, one module at a time |
| Data Format | Direct SQL queries             | Mock JSON + SQL Server            | Client data structure not finalized   |

### 8.3 Authentication Strategy

| Aspect           | Planned        | Actual                         | Reason                                    |
| ---------------- | -------------- | ------------------------------ | ----------------------------------------- |
| Auth Method      | JWT tokens     | Session-based (sessionStorage) | Simplified for prototype phase            |
| Password Storage | bcrypt hashing | Plain text                     | Security deferred to final implementation |
| Firebase         | Not planned    | Installed but not active       | Prepared for future use                   |

### 8.4 Implementation Priority

| Aspect                  | Planned       | Actual                  | Reason                                |
| ----------------------- | ------------- | ----------------------- | ------------------------------------- |
| Thermal Dashboard       | P2 (skeleton) | P0 (fully implemented)  | Used as SQL Server integration pilot  |
| Authentication Security | P0            | Deferred to final phase | Focus on core business features first |

---

## 9. Design Decisions and Rationale

### 9.1 Why Gradual Database Migration?

**Decision**: Migrate one module at a time to SQL Server instead of all at once

**Rationale**:

- Lower risk of system-wide failures
- Thermal module serves as pilot implementation
- Client's SQL Server data structure still being finalized
- Easier to debug and troubleshoot issues
- Team can learn from first migration before scaling

**Current Status**: Thermal successfully migrated, others pending

---

### 9.2 Why Session-based Auth Instead of JWT?

**Decision**: Use simple sessionStorage instead of JWT tokens

**Rationale**:

- Prototype phase prioritizes functionality over security
- Faster development without token management complexity
- Sufficient for development and demonstration purposes
- JWT and Firebase will be implemented in final phase
- Focus resources on core business features first

**Future Plan**: Implement JWT + Firebase authentication in final phase

---

### 9.3 Why No Model Classes?

**Decision**: Use functional programming with Hooks and Services instead of OOP classes

**Rationale**:

- React ecosystem strongly favors functional components and Hooks
- Hooks provide better code reusability and composition
- Service layer pattern is cleaner for API calls
- Easier to test and maintain
- Class diagram serves as design reference, not implementation mandate

**Actual Pattern**:

- Custom Hooks for state logic (useAuth, useThermalData, etc.)
- Service classes for API calls (UserService, ElectricityService, etc.)
- Functional components for UI
- Context API for global state

---

### 9.4 Why Implement Thermal Dashboard Early?

**Decision**: Fully implement Thermal Dashboard (P2) before Electricity Dashboard (P1)

**Rationale**:

- Needed a pilot module for SQL Server integration
- Thermal data structure was ready and available
- Could validate database connection approach
- Lessons learned applied to future modules
- Demonstrates full-stack capability early

**Result**: Successful SQL Server integration, reusable patterns established

---

### 9.5 Why Mock Data for Most Modules?

**Decision**: Continue using Mock JSON data for most modules

**Rationale**:

- Client's SQL Server data structure not finalized
- Allows rapid development without database dependencies
- Easy to reset and test with controlled data
- No database permission or connection issues
- Can develop frontend and backend independently

**Migration Plan**: Migrate to SQL Server after data structure confirmed

---

## 10. Current Architecture (Actual Implementation)

### 10.1 Frontend Architecture

**Pattern**: Functional Components + Custom Hooks + Service Layer

```
Frontend Structure:
‚îú‚îÄ‚îÄ components/          (UI Components)
‚îÇ   ‚îú‚îÄ‚îÄ CarbonFootprint/ (Carbon-specific components)
‚îÇ   ‚îú‚îÄ‚îÄ Thermal/         (Thermal-specific components)
‚îÇ   ‚îú‚îÄ‚îÄ UserManagement/  (User management components)
‚îÇ   ‚îú‚îÄ‚îÄ Common/          (Reusable components)
‚îÇ   ‚îî‚îÄ‚îÄ Layout/          (Layout components: Sidebar, AIChatbot)
‚îÇ
‚îú‚îÄ‚îÄ pages/               (Container components, route-level)
‚îÇ   ‚îú‚îÄ‚îÄ LoginPage.jsx
‚îÇ   ‚îú‚îÄ‚îÄ DashboardPage.jsx
‚îÇ   ‚îú‚îÄ‚îÄ UserManagementPage.jsx
‚îÇ   ‚îú‚îÄ‚îÄ CarbonFootprintPage.jsx
‚îÇ   ‚îú‚îÄ‚îÄ ThermalPage.jsx
‚îÇ   ‚îî‚îÄ‚îÄ ComingSoonPage.jsx
‚îÇ
‚îú‚îÄ‚îÄ contexts/            (Global state management)
‚îÇ   ‚îî‚îÄ‚îÄ AuthContext.jsx  (Authentication state)
‚îÇ
‚îú‚îÄ‚îÄ hooks/               (Custom React Hooks)
‚îÇ   ‚îî‚îÄ‚îÄ useAuth.js       (Authentication hook)
‚îÇ
‚îú‚îÄ‚îÄ lib/                 (Utilities and domain-specific logic)
‚îÇ   ‚îú‚îÄ‚îÄ constants/       (Constants definitions)
‚îÇ   ‚îî‚îÄ‚îÄ hooks/           (Domain-specific hooks: useThermalData, etc.)
‚îÇ
‚îú‚îÄ‚îÄ services/            (API communication layer)
‚îÇ   ‚îú‚îÄ‚îÄ UserService.js
‚îÇ   ‚îú‚îÄ‚îÄ ElectricityService.js
‚îÇ   ‚îú‚îÄ‚îÄ ElectricityMapsService.js
‚îÇ   ‚îú‚îÄ‚îÄ ThermalService.js
‚îÇ   ‚îú‚îÄ‚îÄ LoginLogService.js
‚îÇ   ‚îî‚îÄ‚îÄ FirebaseAuthService.js (prepared, not active)
‚îÇ
‚îî‚îÄ‚îÄ App.jsx              (Main routing and layout)
```

**Key Patterns**:

- Container/Presentation component separation
- Custom Hooks for complex state logic
- Service layer for all API calls
- Context API for authentication state
- Protected routes with role-based access

---

### 10.2 Backend Architecture

**Pattern**: Routes ‚Üí Controllers ‚Üí Services ‚Üí Data

```
Backend Structure:
‚îú‚îÄ‚îÄ routes/              (API endpoint definitions)
‚îÇ   ‚îú‚îÄ‚îÄ userRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ electricityRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ thermalRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ loginLogRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ databaseTestRoutes.js
‚îÇ   ‚îî‚îÄ‚îÄ firebaseAuthRoutes.js (prepared, not active)
‚îÇ
‚îú‚îÄ‚îÄ controllers/         (Request handling and response)
‚îÇ   ‚îú‚îÄ‚îÄ userController.js
‚îÇ   ‚îú‚îÄ‚îÄ electricityController.js
‚îÇ   ‚îú‚îÄ‚îÄ thermalController.js
‚îÇ   ‚îú‚îÄ‚îÄ loginLogController.js
‚îÇ   ‚îî‚îÄ‚îÄ firebaseAuthController.js (prepared, not active)
‚îÇ
‚îú‚îÄ‚îÄ services/            (Business logic and data operations)
‚îÇ   ‚îú‚îÄ‚îÄ userService.js
‚îÇ   ‚îú‚îÄ‚îÄ electricityService.js
‚îÇ   ‚îú‚îÄ‚îÄ thermalService.js
‚îÇ   ‚îî‚îÄ‚îÄ loginLogService.js
‚îÇ
‚îú‚îÄ‚îÄ db/                  (Database utilities)
‚îÇ   ‚îî‚îÄ‚îÄ sqlcmdQuery.js   (SQL Server query helper)
‚îÇ
‚îú‚îÄ‚îÄ firebase/            (Firebase configuration)
‚îÇ   ‚îî‚îÄ‚îÄ admin.js         (prepared, not active)
‚îÇ
‚îú‚îÄ‚îÄ config/              (Configuration)
‚îÇ   ‚îú‚îÄ‚îÄ config.js        (Environment and paths)
‚îÇ   ‚îî‚îÄ‚îÄ database.js      (Database configuration and constants)
‚îÇ
‚îî‚îÄ‚îÄ server.js            (Express server entry point)
```

**Key Patterns**:

- RESTful API design
- Layered architecture (separation of concerns)
- Centralized configuration (database.js eliminates magic strings/numbers)
- Centralized error handling
- CORS configuration for Vercel deployment
- Environment-based configuration

---

### 10.3 Data Flow

```
User Action (Frontend)
    ‚Üì
UI Component (React)
    ‚Üì
Custom Hook (if complex state)
    ‚Üì
Service Layer (API call)
    ‚Üì
HTTP Request (fetch)
    ‚Üì
Backend Route
    ‚Üì
Controller (request validation)
    ‚Üì
Service (business logic)
    ‚Üì
Data Source (Mock JSON or SQL Server)
    ‚Üì
Response (JSON)
    ‚Üì
Service Layer (Frontend)
    ‚Üì
State Update (Hook or Context)
    ‚Üì
UI Re-render
```

---

### 10.4 Authentication Flow

```
1. User enters credentials ‚Üí LoginPage
2. LoginPage calls UserService.authenticate()
3. Backend validates against users.json
4. If valid, create login log entry
5. Return user object with lastLoginId
6. Frontend stores in sessionStorage
7. AuthContext provides user state globally
8. Protected routes check authentication
9. Sidebar filters by user permissions
10. Auto-logout after 30 minutes of inactivity
```

---

### 10.5 Database Connection (Thermal Module)

```
Frontend Request
    ‚Üì
ThermalService.js (API call)
    ‚Üì
Backend thermalRoutes.js
    ‚Üì
thermalController.js
    ‚Üì
thermalService.js
    ‚Üì
sqlcmdQuery.js (executes sqlcmd command)
    ‚Üì
SQL Server (TestSlimDB database)
    ‚Üì
Returns data
    ‚Üì
Response to frontend
```

**SQL Server Configuration**:

- Server: `.\SQLEXPRESS` (SQL Server Express instance)
- Database: TestSlimDB
- Authentication: Windows Authentication (default)
- Query Tool: sqlcmd command-line utility with `-C` flag (trust certificate)
- Configuration: Centralized in `config/database.js`

---

## 11. Quick Facts for AI

**Project Basics**:

- Project Name: EcoSphere
- Type: Smart Building Analytics System
- Client: SAIT GBTAC (Green Building Technology Access Centre)
- Development Phase: Phase 3 - Small System Prototype
- Timeline: 15 weeks (Jan 6 - Apr 17, 2026)

**Technical Stack**:

- Frontend: React 19.2.0 + Vite + Material-UI 7.3.5
- Backend: Node.js + Express 5.1.0
- Database: Mock JSON (transitioning to SQL Server)
- Charts: Chart.js 4.5.1
- Authentication: Session-based (JWT planned for later)

**Progress Summary**:

- Total Planned Modules: 10
- Completed Modules: 5 (Login, User Management, Carbon Footprint, Electricity, Thermal)
- In Progress: 0
- Not Started: 5
- Overall Completion: ~50% (P0 complete, P1 complete, P2 partial)

**Data Sources**:

- SQL Server: 2 modules (Thermal, Electricity)
- Mock JSON: 4 modules (Carbon, Users, Login Logs, Water data not created)
- External API: 1 (Electricity Maps for carbon intensity)

**Code Statistics**:

- Frontend Pages: 7 (added ElectricityReportPage)
- Frontend Services: 6
- Backend Routes: 6
- Backend Controllers: 5
- Backend Services: 4
- Custom Hooks: 6+ (added useElectricityData)
- Electricity Components: 13 (7 shared + 3 consumption + 2 generation + 1 net energy)

**Deployment**:

- Frontend: Vercel-ready
- Backend: Vercel-ready (serverless export)
- CORS: Configured for production URLs

**Test Accounts**:

- 3 users in system (1 SuperAdmin, 1 Admin, 1 TeamMember)
- All use password: abcd1234

---

## 12. Next Priorities

### Immediate Next Steps (Priority Order)

1. **Water Dashboard Implementation** (P2)

   - Design: Basic data display with charts
   - Data Source: SQL Server (structure to be confirmed)
   - Features: Water consumption tracking and analysis
   - Timeline: Next development cycle

2. **Carbon Footprint Integration with Electricity**

   - Update: Migrate Carbon Footprint from Mock JSON to SQL Server
   - Integration: Use TL341 consumption data directly
   - Enhancement: Real-time carbon intensity from Electricity Maps API
   - Timeline: After Water Dashboard

3. **Advanced Electricity Features**

   - Period comparison (YoY/PoP)
   - Self-sufficiency rate visualization
   - Export functionality for Electricity Report
   - Timeline: Future enhancement

### Future Phases

**Phase 1: Core Dashboards** (COMPLETED)

- ‚úÖ Complete Electricity Dashboard
- ‚è≥ Implement Water Dashboard
- ‚úÖ Migrate Electricity to SQL Server

**Phase 2: Advanced Features** (Weeks 11-12)

- AI Chatbot (Google Gemini API)
- Forecast/Prediction models
- Period comparison (YoY/PoP)
- 3D Thermal Visualization

**Phase 3: Security and Polish** (Weeks 13-15)

- Implement JWT authentication
- Integrate Firebase
- Password encryption (bcrypt)
- Security audit
- Performance optimization

---

## 13. Important Technical Decisions

### 13.1 Timezone Handling Strategy (Defensive Programming)

**Context**: 
- Database stores all timestamps in **Calgary local time** (MST/MDT, UTC-7/-6)
- Application is designed to run in Calgary timezone
- No timezone information stored in database timestamps

**Challenge**:
When creating JavaScript Date objects from date strings (e.g., `new Date('2020-11-08')`), different browsers may interpret the string differently:
- Some browsers treat it as local time: `2020-11-08 00:00:00 MST`
- Others treat it as UTC time: `2020-11-08 00:00:00 UTC` ‚Üí converts to `2020-11-07 17:00:00 MST` (previous day!)

**Solution - Defensive Programming Approach**:
To ensure consistent behavior across all browsers and prevent date boundary issues, we add `T12:00:00` (noon time) when creating Date objects from date strings:

```javascript
// ‚ùå RISKY - May cause date shift in some browsers
const date = new Date('2020-11-08');  // Could become 2020-11-07 in Calgary

// ‚úÖ SAFE - Noon time prevents date boundary crossing
const date = new Date('2020-11-08T12:00:00');  // Always 2020-11-08 regardless of timezone
```

**Why Noon Time (12:00:00)?**
- Even if browser applies timezone conversion, noon time won't cross date boundaries
- Calgary is UTC-7, so worst case: `2020-11-08 12:00:00 UTC` ‚Üí `2020-11-08 05:00:00 MST` (still same day)
- Provides safety margin for any timezone interpretation

**Implementation Locations**:
- Frontend date formatting: `ElectricityReportService.js`, `useThermalData.js`
- Frontend date pickers: `ElectricityReportPage.jsx`, `ThermalPage.jsx`, `ElectricityTimeFilter.jsx`
- Backend date validation: `electricityController.js` (uses string comparison instead of Date objects)

**Key Principle**:
Always use **local time methods** (`getFullYear()`, `getMonth()`, `getDate()`) instead of UTC methods (`getUTCFullYear()`, etc.) since database times are local Calgary time.

**Benefits**:
1. **Browser Compatibility**: Works consistently across all browsers
2. **Future-Proof**: If someone accesses the app from a different timezone, dates still display correctly
3. **Defensive**: Prevents subtle bugs from timezone edge cases
4. **Maintainable**: Clear pattern for all date handling in the codebase

**Database Date Ranges** (Verified 2026-01-02):
- **Electricity** (TL339, TL340, TL341): 2019-02-13 to 2020-11-08
- **Thermal** (SaitSolarLab_20004_TL2): 2019-01-01 to 2020-11-08

---

## 14. Known Limitations and Technical Debt

### Current Limitations

1. **Authentication Security**

   - Plain text password storage
   - No password reset functionality
   - No email verification
   - Session-based only (no token refresh)
2. **Data Persistence**

   - Most modules use Mock JSON (not scalable)
   - Custom Calculator data not persisted
   - Login logs in JSON (should be in database)
3. **Error Handling**

   - Basic error messages
   - No centralized error logging
   - Limited user feedback on failures
4. **Testing**

   - No unit tests implemented
   - No integration tests
   - No E2E tests
   - Manual testing only
5. **Performance**

   - No data pagination
   - No lazy loading for large datasets
   - No caching strategy (except Electricity Maps API)

### Technical Debt

1. **Code Organization**

   - Some components exceed 150 lines (e.g., CarbonFootprintPage.jsx)
   - Duplicate code in export functionality
   - Inconsistent error handling patterns
2. **Documentation**

   - Limited inline code comments
   - No API documentation (Swagger/OpenAPI)
   - No component documentation (Storybook)
3. **Configuration**

   - Hardcoded API URLs in some places
   - Environment variables not fully utilized
   - No configuration validation
4. **Accessibility**

   - Limited ARIA labels
   - No keyboard navigation testing
   - No screen reader testing

---

## 14. Reference Documents

### Planning Documents

- **Project Introduction**: `1.EcoSphereIntroduction.md` - Full project background, requirements, and 15-week timeline
- **Implementation Plan**: `2.IMPLEMENTATION_PLAN-cn.md` - Detailed implementation plan with class definitions and API design
- **Architecture Design**: `3.ARCHITECTURE-cn.md` - Original architecture design and technical decisions
- **Current State**: `4.CURRENT_STATE.md` - This document

### Database Analysis Documents

- **Electricity Tables Analysis (English)**: `.documentation/ReadMeBeforeStart/electricity/ELECTRICITY_TABLES_ANALYSIS_EN.md` - Comprehensive analysis of 21 electricity database tables, including table relationships, data classification, and implementation recommendations
- **Electricity Tables Analysis (Chinese)**: `.documentation/ReadMeBeforeStart/electricity/ELECTRICITY_TABLES_ANALYSIS_CN.md` - Chinese version of the electricity database analysis

### External References

- Class Diagram: `instructions/ref/class-diagram-optimized.puml`
- ERD Diagram: `instructions/ref/erd-diagram.puml`
- Sequence Diagrams: `deliverables/seq-*.puml`
- Activity Diagrams: `deliverables/activity-*.puml`

### Code Locations

- Frontend: `ecosphere-frontend/src/`
- Backend: `ecosphere-backend/`
- Mock Data: `mock-data/`
- Documentation: `.documentation/`

### Key Configuration Files

- **Database Configuration**: `ecosphere-backend/config/database.js`
  - Centralized database constants (table names, query parameters, time constants)
  - sqlcmd path detection and command building
  - Eliminates magic strings/numbers throughout codebase
  - Single source of truth for all database-related configuration
  
- **Environment Variables**: `ecosphere-backend/.env`
  - `DB_SERVER=.\SQLEXPRESS` (SQL Server instance)
  - `DB_DATABASE=TestSlimDB`
  - Windows Authentication (no credentials needed)

---

## Document Maintenance

**How to Update This Document**:

1. Update after completing each major feature
2. Update when making architectural changes
3. Update when deviating from original plan
4. Keep "Last Updated" date current
5. Maintain accuracy - only document what actually exists

---

**End of Document**
