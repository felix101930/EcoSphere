# EcoSphere Project - Current Implementation State

**Document Purpose**: Provide accurate status of actual implementation vs original planning documents
**Last Updated**: 2026-01-05 (Backend refactoring completed, Generation forecast with weather API integrated)
**Current Phase**: Phase 3 - Small System Prototype
**Target Reader**: AI Assistants and Project Team

---

## 1. Current Status Summary

The EcoSphere project has completed all P0 (Priority 0) core functionalities including Login, User Management, and Carbon Footprint Tracking modules, as well as P1 Electricity Dashboard and Overview Dashboard. Additionally, complete Thermal and Water Dashboards have been implemented ahead of schedule, along with comprehensive Electricity Forecast functionality using multi-tier algorithms and weather-based generation prediction. The project currently uses SQL Server for all data modules (Thermal, Electricity, Water, and Carbon Footprint), while User Management and Login Logs still use Mock JSON data. The Carbon Footprint module has been fully migrated to SQL Server and now uses historical carbon intensity data from Electricity Maps API. The authentication system uses simple session-based approach instead of JWT, and the architecture follows React Hooks and modular patterns rather than traditional OOP class structures defined in planning documents. Significant backend refactoring has been completed to establish code standards and improve maintainability.

**Overall Progress**: P0 100% Complete | P1 100% Complete | P2 80% Complete (Thermal + Water + Forecast)

**Last Updated**: 2026-01-05 (Backend refactoring + Generation forecast with weather API)

---

## 2. Implementation Progress Overview

| Priority | Module                    | Original Plan         | Actual Status                      | Completion | Notes                    |
| -------- | ------------------------- | --------------------- | ---------------------------------- | ---------- | ------------------------ |
| P0       | Login Module              | Basic authentication  | Session-based auth with login logs | 100%       | Simplified for prototype |
| P0       | User Management           | Admin CRUD operations | Full CRUD with permissions         | 100%       | Complete                 |
| P0       | Carbon Footprint Tracking | Two calculation modes | SQL Server + Historical API data   | 100%       | Enhanced with real data  |
| P1       | Electricity Dashboard     | Basic data display    | FULLY IMPLEMENTED                  | 100%       | Complete with 4 tabs     |
| P1       | Overview Dashboard        | Not in original plan  | FULLY IMPLEMENTED                  | 100%       | Unified view of all data |
| P2       | Water Dashboard           | Basic data display    | FULLY IMPLEMENTED                  | 100%       | Complete with 2 tabs     |
| P2       | Thermal Dashboard         | Skeleton only         | FULLY IMPLEMENTED                  | 100%       | Ahead of schedule        |
| P2       | 3D Visualization          | Skeleton only         | Not Started                        | 0%         | Future                   |
| P2       | Forecast/Prediction       | Skeleton only         | PARTIALLY IMPLEMENTED              | 50%        | Electricity consumption + generation |
| P2       | AI Chatbot (EVA)          | Skeleton only         | Not Started                        | 0%         | Future                   |
| P2       | Quiz System               | Skeleton only         | Not Started                        | 0%         | Future                   |

---

## 3. Technology Stack: Planned vs Actual

| Component                    | Original Plan    | Actually Implemented                  | Reason for Difference          |
| ---------------------------- | ---------------- | ------------------------------------- | ------------------------------ |
| **Frontend Framework** | React 18.x       | React 19.2.0                          | Used latest stable version     |
| **Build Tool**         | Vite             | Vite 7.2.4                            | As planned                     |
| **UI Library**         | Material-UI 5.x  | Material-UI 7.3.5                     | Used latest version            |
| **State Management**   | Context API      | Context API                           | As planned                     |
| **Charts**             | Chart.js         | Chart.js 4.5.1 + react-chartjs-2      | As planned                     |
| **Routing**            | React Router 6.x | React Router 7.9.6                    | Used latest version            |
| **Date Handling**      | Not specified    | date-fns 4.1.0                        | Added for date operations      |
| **PDF Export**         | Not specified    | jsPDF 3.0.4 + html2canvas 1.4.1       | Added for export feature       |
| **Backend Framework**  | Express 4.x      | Express 5.1.0                         | Used latest version            |
| **Authentication**     | JWT Token        | Session-based (sessionStorage)        | Simplified for prototype phase |
| **Password Security**  | bcrypt hashing   | Plain text comparison                 | Deferred to final phase        |
| **Database**           | SQL Server       | Mock JSON + SQL Server (Thermal only) | Gradual migration strategy     |
| **ORM**                | Sequelize/Prisma | None (direct queries)                 | Not needed for current phase   |
| **Firebase**           | Not in plan      | Partially installed (not active)      | Prepared but not implemented   |

---

## 4. Data Source Status

| Module           | Planned Source | Current Source               | Migration Status | Notes                                     |
| ---------------- | -------------- | ---------------------------- | ---------------- | ----------------------------------------- |
| Thermal          | SQL Server     | SQL Server                   | ‚úÖ COMPLETED     | Using sqlcmdQuery.js                      |
| Electricity      | SQL Server     | SQL Server                   | ‚úÖ COMPLETED     | Using optimized hourly aggregation        |
| Water            | SQL Server     | SQL Server                   | ‚úÖ COMPLETED     | TL93 (rainwater), TL210 (hot water)       |
| Carbon Footprint | SQL Server     | SQL Server + Electricity Maps API | ‚úÖ COMPLETED | TL341 consumption + historical intensity  |
| Users            | SQL Server     | Mock JSON (users.json)       | üìã PLANNED       | 3 test users                              |
| Login Logs       | SQL Server     | Mock JSON (loginLogs.json)   | üìã PLANNED       | Tracks login/logout                       |

**Database Location**: `C:\XW\SAIT\GB\`
- `TestSlimDB.mdf` - Main database file
- `TestSlimDB_log.ldf` - Log file

**Database Location**: `C:\XW\SAIT\GB\`
- `TestSlimDB.mdf` - Main database file
- `TestSlimDB_log.ldf` - Log file

**Backend .env Configuration**:
```
DB_SERVER=.\SQLEXPRESS
DB_DATABASE=TestSlimDB
# Windows Authentication (no username/password needed)
```

**Important Notes**:
- Use `.\SQLEXPRESS` (not `localhost`) for SQL Server instance name
- sqlcmd requires `-C` flag to trust server certificate (ODBC Driver 18)
- Database configuration centralized in `config/database.js`

**Migration Strategy**: One module at a time, starting with Thermal as pilot implementation.

### 4.1 Electricity Database Analysis (Completed 2025-12-23)

A comprehensive analysis of GBTAC's electricity database tables has been completed. The analysis identified 21 tables in the TestSlimDB database (SaitSolarLab_* schema) and classified them by usability and purpose.

**Table Status Summary**:
- ‚úÖ USABLE - Primary (Long-term Data): 3 tables (TL341, TL340, TL339)
- ‚ö†Ô∏è USABLE - Secondary (Limited/Cumulative): 15 tables
- üìä USABLE - Historical Only: 1 table (TL3 - replaced by TL340)
- ‚ùå UNUSABLE - Invalid Data: 2 tables (TL208, TL388)

**Key Findings**:

1. **Primary Data Sources (594 days: 2019-03-25 ‚Üí 2020-11-08)**:
   - TL341: Consumption Hourly Increment (634 days including 40 extra days)
   - TL340: Generation Hourly Increment (634 days including 40 extra days)
   - TL339: Net Energy Hourly Increment (634 days including 40 extra days)
   - These three tables provide the most reliable long-term historical data

2. **Table Relationships Verified**:
   - TL337 (Cumulative) = base + sum(TL341) - Consumption tracking
   - TL336 (Cumulative) = base + sum(TL340) - Generation tracking
   - TL338 (Cumulative) = base + sum(TL339) - Net Energy tracking
   - TL342 = TL343 + TL344 + TL345 - Three-phase power breakdown

3. **Data Classification Structure**:
   - **Consumption**: Overall measurement (TL337/TL341), By phase (TL342-345), By equipment (TL208-213, TL4)
   - **Generation**: Overall measurement (TL336/TL340), By source (TL252-253), Historical (TL3)
   - **Net Energy**: Overall measurement (TL338/TL339), Alternative (TL335)

4. **Recommended Tables for Dashboard Implementation**:
   - Long-term analysis: TL341 (consumption), TL340 (generation), TL339 (net energy)
   - Recent detailed analysis: TL342-345 (three-phase breakdown, 7 days only)
   - Equipment breakdown: TL213, TL4 (2020 data), TL209-212 (2019 data)

**Documentation**: Complete analysis available in `.documentation/ReadMeBeforeStart/electricity/ELECTRICITY_TABLES_ANALYSIS_EN.md` and `ELECTRICITY_TABLES_ANALYSIS_CN.md`

**Next Steps**: 
- ‚úÖ COMPLETED: Electricity Dashboard implemented with SQL Server integration
- Integrate carbon footprint calculation with TL341 consumption data
- Consider implementing Water Dashboard next

---

## 5. Completed Features (P0 - 100%)

### 5.1 Login Module

**Planned**: Basic user authentication with JWT tokens

**Actually Implemented**:

- Simple email/password authentication
- Session management using sessionStorage
- Login log tracking with IP address
- Automatic 30-minute session timeout
- Role-based redirect (Admin to /users, TeamMember to /dashboard)

**Key Implementation Files**:

- Frontend: `LoginPage.jsx`, `AuthContext.jsx`, `useAuth.js`
- Backend: `userRoutes.js`, `userController.js`, `userService.js`
- Service: `LoginLogService.js`

**Test Accounts**:

- Super Admin: super.admin@edu.sait.ca / abcd1234
- Admin: xujun.wang@edu.sait.ca / abcd1234
- Team Member: test.member@edu.sait.ca / abcd1234

---

### 5.2 User Management Module

**Planned**: Admin can add/edit/delete users with role assignment

**Actually Implemented**:

- Full CRUD operations for users
- Three roles: SuperAdmin, Admin, TeamMember
- Five permission types: electricity, water, thermal, 3d-model, carbon-footprint
- Permission-based sidebar filtering
- Cannot delete self or SuperAdmin
- Form validation and error handling

**Key Implementation Files**:

- Frontend: `UserManagementPage.jsx`, `UserTable.jsx`, `UserTableRow.jsx`, `UserDialog.jsx`, `UserForm.jsx`
- Backend: `userRoutes.js`, `userController.js`, `userService.js`
- Services: `UserService.js`

**Features**:

- View all users in table format
- Add new user with role and permissions
- Edit existing user information
- Delete user (with restrictions)
- Real-time permission updates

---

### 5.3 Carbon Footprint Tracking Module

**Planned**: Two calculation modes with basic visualization

**Actually Implemented**:

- **Mode 1: Automatic Calculation from SQL Server**

  - Reads from TL341 (Consumption) table via SQL Server
  - Integrates Electricity Maps API for historical carbon intensity data
  - Time presets: Today, Yesterday, Last 7 Days, Last 30 Days, Custom
  - Demo dates based on available data (Nov 2020):
    - Today = Nov 8, 2020
    - Yesterday = Nov 7, 2020
    - Last 7 Days = Nov 2-8, 2020
    - Last 30 Days = Oct 10 - Nov 8, 2020
  - Custom date picker with date range validation
  - Smart data display:
    - Single day (Today/Yesterday): Hourly intervals (24 data points)
    - Multiple days (Last 7/30 Days, Custom): Daily intervals (aggregated)
  - Historical carbon intensity: Each day uses its specific carbon intensity from Electricity Maps API
  - Automatic CO2 calculation: Energy (kWh) √ó Carbon Intensity (kg CO2/kWh)
  - Uses absolute values (consumption is negative in database, displayed as positive)
- **Mode 2: Custom Calculator (User Upload)**

  - User inputs electricity bills (year, month, usage)
  - Real-time calculation without persistence
  - Dynamic add/remove bill entries
  - Data validation (no duplicates, no future dates)
  - Auto-sort by year and month
  - Uses average carbon intensity from historical data
- **Visualization**:

  - Chart.js line chart with single Y-axis (Energy + Carbon on same scale)
  - Compact legend (2px height rectangles)
  - SAIT color scheme (Blue for energy, Red for carbon)
  - Interactive tooltips showing carbon intensity for each data point
  - Responsive design
  - Metrics cards showing:
    - Energy Consumption (total and average per day/hour)
    - Carbon Footprint (total and average per day/hour)
- **Export Feature**:

  - PDF export with jsPDF + html2canvas
  - Export dialog component

**Key Implementation Files**:

- Frontend: `CarbonFootprintPage.jsx`, `TimePresetSelector.jsx`, `AutomaticCalculationView.jsx`, `CustomCalculator.jsx`
- Custom Hooks: `useCarbonFootprintData.js`
- Constants: `carbonFootprint.js` (centralized configuration)
- Services: `ElectricityReportService.js`, `ElectricityMapsService.js`
- Backend: `electricityRoutes.js`, `electricityController.js`, `electricityService.js`

**External API Integration**:

- Electricity Maps API (Alberta, CA-AB zone)
- Historical carbon intensity endpoint: `/carbon-intensity/past-range`
- API key managed in .env file
- 1-hour cache to reduce API calls
- Fallback carbon intensity: 0.65 kg CO2/kWh

**Data Source**: SQL Server (TL341 - Consumption Hourly Increment)
- Available range: 2019-02-13 to 2020-11-08
- Hourly data for single days
- Daily aggregation for multi-day periods

**Technical Highlights**:

- Timezone-safe date handling (T12:00:00 pattern)
- Defensive programming for date boundary issues
- Component reusability (similar to Electricity/Water modules)
- Enterprise React standards (components <150 lines)
- Centralized constants (no magic strings/numbers)

---

### 5.4 Electricity Report Module

**Planned**: P1 priority, basic data display with charts

**Actually Implemented**: Complete electricity dashboard with four tabs and comprehensive data visualization

**Features**:

- **Four Main Tabs**:
  - Consumption: Overall consumption + Phase breakdown + Equipment breakdown
  - Generation: Overall generation + Solar source breakdown (Carport vs Rooftop)
  - Net Energy: Net energy analysis with sign preservation (negative = consumer, positive = producer)
  - Forecast: Electricity consumption prediction with multi-tier algorithm system

- **Consumption Tab**:
  - Overall trend chart (hourly data)
  - Key metrics cards (Total, Average, Peak, Min)
  - Breakdown selector (Overall, By Phase, By Equipment)
  - Phase breakdown: 3-phase power analysis (Phase A, B, C + Total)
  - Equipment breakdown: 5 categories (Panel2A-1, Ventilation, Lighting, Equipment, Appliances)
  - Data source: TL341 (overall), TL342-345 (phase), TL213/TL4/TL209-212 (equipment)

- **Generation Tab**:
  - Overall trend chart (hourly data)
  - Key metrics cards (Total, Average, Peak, Min)
  - Breakdown selector (Overall, By Solar Source)
  - Solar source breakdown: Pie chart showing Carport vs Rooftop distribution
  - Data source: TL340 (overall), TL252-253 (solar source)

- **Net Energy Tab**:
  - Overall trend chart with sign preservation (shows negative and positive values)
  - Key metrics cards with color coding (red for negative, green for positive)
  - Status indicators (Net Consumer vs Net Producer)
  - Peak Surplus and Peak Deficit metrics
  - Explanatory info cards
  - Data source: TL339

- **Forecast Tab** (UPDATED 2026-01-05):
  - **Multi-Tier Algorithm System**: 4-tier graceful degradation based on data availability
    - Tier 1: Holt-Winters Seasonal Smoothing (90% confidence, requires 1 year + 70% completeness)
    - Tier 2: Seasonal Weighted Prediction (80% confidence, requires last year + 30 days)
    - Tier 3: Trend-Based Prediction (65% confidence, requires 30 days)
    - Tier 4: Moving Average (50% confidence, requires 7 days)
  - **Generation Forecast** (NEW):
    - Weather-based linear regression model using Open-Meteo API
    - Simple linear regression: `Generation = a √ó Direct_Radiation + b`
    - Uses direct solar radiation as primary predictor (correlation: 0.80)
    - Location: Calgary, AB (51.0947¬∞N, 114.1094¬∞W)
    - Training: 60 days of historical data before target date
    - Weather variables: Direct radiation, temperature, cloud cover, shortwave radiation, diffuse radiation
    - Automatic selection between historical weather data (MVP) and forecast data (production)
  - **Forecast Configuration**:
    - Removed forecast type selector - always shows both consumption and generation
    - Forecast period selector: 7, 14, or 30 days
    - Auto-generates forecast when date or period changes
  - **Data Availability Analysis**:
    - Data completeness score (0-100%)
    - Available data checks (7 days, 30 days, last year, 1-year cycle)
    - Missing data periods identification
    - Recommended algorithm with confidence level
  - **Algorithm Visualization**:
    - 4-column grid showing all algorithm tiers with uniform width
    - Active algorithm highlighted with green background
    - Info icon with tooltip showing formula and description for each tier
    - Complete requirements and features for each tier
  - **Forecast Chart**:
    - Dual-line chart showing both consumption (red) and generation (green) predictions
    - Data labels directly on chart points
    - Summary statistics for both forecasts
    - Net energy calculation when both present
    - SAIT color scheme (Red for consumption, Green for generation)
  - **Generation Forecast Info Card** (NEW):
    - Displays prediction formula with coefficient explanations
    - Shows weather data source (Open-Meteo API)
    - Lists weather variables used
    - Training data information
    - No R¬≤ display (removed for simplicity)
  - **Technical Implementation**:
    - Uses timeseries-analysis library for Holt-Winters algorithm
    - Simple linear regression for generation forecast
    - Weather service integration with Open-Meteo API
    - Intelligent algorithm selection based on data quality
    - Parallel loading of both forecasts for better performance

- **Performance Optimization**:
  - Hourly aggregation for all breakdown data (consistent intervals)
  - Optimized SQL queries using DATEPART for 270x faster performance (35s ‚Üí 130ms)
  - Auto-load data when switching tabs
  - Date range filter with validation

- **Data Visualization**:
  - Chart.js line charts for trends
  - Chart.js pie chart for solar source breakdown
  - Dual-axis support for phase/equipment comparisons
  - Interactive legends and tooltips
  - SAIT color scheme (Red #DA291C, Blue #005EB8, Purple #9C27B0)

- **Export Feature**:
  - PDF export for each tab (Consumption, Generation, Net Energy)
  - Uses common ExportReportDialog component
  - Exports current tab view with all charts and metrics
  - SAIT branding and timestamp included
  - Preview and download options available

**Key Implementation Files**:

- Frontend Pages: `ElectricityReportPage.jsx`
- Frontend Components: 
  - Shared: `ElectricityTimeFilter.jsx`, `MetricsCards.jsx`, `OverallTrendChart.jsx`, `BreakdownSelector.jsx`
  - Consumption: `ConsumptionTab.jsx`, `PhaseBreakdownChart.jsx`, `EquipmentBreakdownChart.jsx`
  - Generation: `GenerationTab.jsx`, `SolarSourceBreakdownChart.jsx`
  - Net Energy: `NetEnergyTab.jsx`, `NetEnergyMetricsCards.jsx`
  - Forecast: `ForecastTab.jsx`, `DataAvailabilityCard.jsx`, `ForecastChart.jsx`
- Custom Hooks: `useElectricityData.js`, `useForecastData.js`
- Services: `ForecastService.js` (frontend), `ElectricityReportService.js`
- Constants: `forecast.js` (forecast periods, colors, labels)
- Backend: `electricityRoutes.js`, `electricityController.js`, `electricityService.js`, `forecastRoutes.js`, `forecastController.js`, `forecastService.js`

**Database Tables Used**:

- Primary (634 days: 2019-02-13 to 2020-11-08):
  - TL341: Consumption Hourly Increment (used for forecast)
  - TL340: Generation Hourly Increment
  - TL339: Net Energy Hourly Increment
- Secondary (7 days: 2020-11-01 to 2020-11-08):
  - TL342-345: Three-phase breakdown (1-min intervals, aggregated to hourly)
  - TL252-253: Solar source breakdown (1-min intervals, aggregated to hourly)
- Equipment (various date ranges):
  - TL213: Panel2A-1 (9 months: 2020-02-15 to 2020-11-08)
  - TL4: Ventilation (7 days: 2020-11-01 to 2020-11-08)
  - TL209-212: Lighting, Equipment, Appliances (7 days: 2019-11-07 to 2019-11-14)

**Technical Highlights**:

- SQL Server integration with optimized queries
- Hourly aggregation strategy for consistent performance
- Sign preservation for Net Energy (critical for understanding grid dependency)
- Industry-standard Holt-Winters algorithm for forecasting
- Graceful degradation when data is insufficient
- Component reusability (OverallTrendChart used across all tabs)
- Enterprise React standards (components <150 lines, Hooks at top)
- **State Management Pattern**: Clear all cached data when date filter changes to ensure all tabs reload with new date range (prevents stale data in inactive tabs)

---

## 6. Additional Features (Not in Original P0 Plan)

### 6.1 Overview Dashboard (Fully Implemented)

**Original Plan**: Not in original plan

**Actually Implemented**: Complete unified overview dashboard showing all modules on one page

**Features**:

- **Unified View**: All three modules (Electricity, Water, Thermal) displayed on single page
- **Collapsible Sections**: Each module section can be expanded/collapsed independently
- **Time Presets**: Four preset options (Demo Day, Today, Yesterday, Last 7 Days)
  - Demo Day: 2020-11-01 to 2020-11-08 (8 days with data for all modules)
  - No custom date picker - users go to specific module pages for custom dates
- **Daily Aggregation**: Multi-day periods display daily intervals (one point per day)
- **Key Metrics Display**: Shows essential metrics only (no detailed breakdowns)
- **Trend Charts**: Displays overall trends for each module
  - Electricity: Consumption, Generation, Net Energy trends
  - Water: Rainwater level, Hot water consumption trends
  - Thermal: Temperature trends for all three floors (Basement, Level 1, Level 2)
- **Data Availability Handling**: Shows "No data" message when data unavailable for selected period
- **Responsive Layout**: 2-column grid on large screens, single column on mobile
- **Scroll to Top**: Quick navigation button for long page

**Data Aggregation**:

- **Electricity**: Uses overall tables (TL341, TL340, TL339) - already aggregated data
- **Water**: Single sensor per metric (TL93 rainwater, TL210 hot water)
- **Thermal**: Multi-sensor averaging - calculates average temperature across all sensors per floor
  - Basement: Average of 3 sensors (20004_TL2, 20005_TL2, 20006_TL2)
  - Level 1: Average of 5 sensors (20007_TL2, 20008_TL2, 20009_TL2, 20010_TL2, 20011_TL2)
  - Level 2: Average of 5 sensors (20012_TL2, 20013_TL2, 20014_TL2, 20015_TL2, 20016_TL2)

**Chart Configuration**:

- Unified Y-axis ranges for thermal charts (15¬∞C to 30¬∞C) for easy comparison
- Consistent color scheme across all modules
- Interactive tooltips and legends

**Key Implementation Files**:

- Frontend Page: `OverviewPage.jsx`
- Frontend Components: 
  - `TimePresetSelector.jsx` (preset buttons)
  - `ElectricityOverview.jsx`, `WaterOverview.jsx`, `ThermalOverview.jsx` (module sections)
  - `CollapsibleSection.jsx`, `CompactMetrics.jsx`, `NoDataMessage.jsx` (common components)
- Custom Hook: `useOverviewData.js` (data loading and aggregation)
- Utilities: `dataAggregation.js` (daily aggregation functions)
- Constants: `overview.js` (date ranges, presets, labels)

**Technical Highlights**:

- Reuses existing service layer (ElectricityReportService, WaterReportService, ThermalService)
- Daily aggregation utility for consistent multi-day display
- Multi-sensor averaging for thermal data (true floor-level temperature)
- Efficient parallel data loading for all three modules
- Component reusability across modules

**Implementation Date**: 2026-01-04

---

### 6.2 Thermal Dashboard (Fully Implemented)

**Original Plan**: P2 priority, skeleton implementation only

**Actually Implemented**: Complete functional thermal dashboard ahead of schedule

**Features**:

- **Two View Modes**:

  - Single Day: Hourly data for selected date
  - Multiple Days: Aggregated data for date range
- **Floor Selection**: Basement, First Floor, Second Floor
- **Data Visualization**:

  - Line chart showing temperature trends
  - Interactive time/date selection
  - Click on chart to jump to specific time
- **Floor Plan Heat Map**:

  - Real-time temperature overlay on floor plan
  - Color-coded temperature zones
  - Multiple sensor support (3 sensors per floor)
- **Time Control**:

  - Time slider (0-95 for 15-minute intervals)
  - Play/pause animation
  - Manual time selection
- **Data Source**: SQL Server (using sqlcmdQuery.js)
- **Export Feature**: PDF export capability

**Key Implementation Files**:

- Frontend: `ThermalPage.jsx`, `ThermalControlPanel.jsx`, `ThermalChartSection.jsx`, `ThermalFloorPlan.jsx`, `ThermalTimeSlider.jsx`
- Custom Hooks: `useThermalData.js`, `useFloorManagement.js`, `useTimeControl.js`
- Services: `ThermalService.js`
- Backend: `thermalRoutes.js`, `thermalController.js`, `thermalService.js`

**Why Implemented Early**: Served as pilot for SQL Server integration

---

### 6.2 Thermal Dashboard (Fully Implemented)

**Original Plan**: P2 priority, skeleton implementation only

**Actually Implemented**: Complete functional thermal dashboard ahead of schedule

**Features**:

- **Two View Modes**:

  - Single Day: Hourly data for selected date
  - Multiple Days: Aggregated data for date range
- **Floor Selection**: Basement, First Floor, Second Floor
- **Data Visualization**:

  - Line chart showing temperature trends
  - Interactive time/date selection
  - Click on chart to jump to specific time
- **Floor Plan Heat Map**:

  - Real-time temperature overlay on floor plan
  - Color-coded temperature zones
  - Multiple sensor support (3 sensors per floor)
- **Time Control**:

  - Time slider (0-95 for 15-minute intervals)
  - Play/pause animation
  - Manual time selection
- **Data Source**: SQL Server (using sqlcmdQuery.js)
- **Export Feature**: PDF export capability

**Key Implementation Files**:

- Frontend: `ThermalPage.jsx`, `ThermalControlPanel.jsx`, `ThermalChartSection.jsx`, `ThermalFloorPlan.jsx`, `ThermalTimeSlider.jsx`
- Custom Hooks: `useThermalData.js`, `useFloorManagement.js`, `useTimeControl.js`
- Services: `ThermalService.js`
- Backend: `thermalRoutes.js`, `thermalController.js`, `thermalService.js`

**Why Implemented Early**: Served as pilot for SQL Server integration

---

### 6.3 Login Log Tracking

**Original Plan**: Basic history logs

**Actually Implemented**: Detailed login/logout tracking

**Features**:

- Records login timestamp
- Captures IP address
- Tracks logout timestamp
- Records user role and email
- Success/failure status

**Key Implementation Files**:

- Backend: `loginLogRoutes.js`, `loginLogController.js`, `loginLogService.js`
- Frontend: `LoginLogService.js`

---

### 6.4 Export Report Functionality

**Original Plan**: P2 priority

**Actually Implemented**: Working export for Carbon Footprint, Thermal, and Electricity modules

**Features**:

- PDF generation using jsPDF
- Screenshot capture using html2canvas
- Export dialog component (reusable)
- Configurable export options
- Preview before download
- SAIT branding and timestamps

**Module-Specific Implementation**:

- **Carbon Footprint**: Custom export dialog with chart capture
- **Thermal**: Uses common ExportReportDialog, exports current view
- **Electricity**: Uses common ExportReportDialog, exports current tab (Consumption/Generation/Net Energy)

**Key Implementation Files**:

- Frontend: `ExportReportDialog.jsx` (Common), `ExportReportDialog.jsx` (CarbonFootprint)
- Integration: `ThermalPage.jsx`, `ElectricityReportPage.jsx`, `CarbonFootprintPage.jsx`

---

### 6.5 Water Dashboard (Fully Implemented)

**Original Plan**: P2 priority, basic data display

**Actually Implemented**: Complete functional water dashboard with two tabs

**Features**:

- **Two Main Tabs**:
  - Rainwater Harvesting: Water level monitoring (%)
  - Hot Water Consumption: Domestic hot water usage (L/h)

- **Data Visualization**:
  - Line charts showing trends over time
  - Key metrics cards (Total/Current, Average, Peak, Min)
  - Time filter with presets (Last 7/30/90 days + Custom)
  - Data info alerts showing available date ranges

- **Data Source**: SQL Server
  - TL93: Rainwater level (10-min intervals, aggregated to hourly)
  - TL210: Hot water consumption (1-min intervals, aggregated to hourly)

- **Performance Optimization**:
  - Hourly aggregation for consistent performance
  - Optimized SQL queries using DATEPART
  - Auto-load data when switching tabs

- **Export Feature**: PDF export capability for both tabs

- **UI Design**:
  - SAIT color scheme (Blue for rainwater, Red for hot water)
  - Responsive design
  - Consistent with Electricity module patterns

**Key Implementation Files**:

- Frontend Pages: `WaterReportPage.jsx`
- Frontend Components: `RainwaterTab.jsx`, `HotWaterTab.jsx`, `TimeFilter.jsx` (refactored from Electricity)
- Custom Hooks: `useWaterData.js`
- Services: `WaterReportService.js`
- Backend: `waterRoutes.js`, `waterController.js`, `waterService.js`

**Database Tables Used**:

- TL93: Rainwater level (56K records, 2018-10-13 to 2020-11-08)
- TL210: Hot water consumption (556K records, 2018-09-11 to 2019-11-14)

**Technical Highlights**:

- Reused and enhanced existing components (OverallTrendChart, MetricsCards)
- Created generic TimeFilter component (refactored from Electricity)
- Followed enterprise React standards (components <150 lines)
- Timezone-safe date handling (T12:00:00 pattern)
- Component reusability across modules

**Implementation Date**: 2026-01-04

---

## 7. Pending Features

### 7.1 Priority 1 (P1)

| Feature               | Status    | Notes                                 |
| --------------------- | --------- | ------------------------------------- |
| Electricity Dashboard | COMPLETED | All 3 tabs implemented with SQL Server |

### 7.2 Priority 2 (P2)

| Feature                     | Status      | Notes                                  |
| --------------------------- | ----------- | -------------------------------------- |
| Water Dashboard             | COMPLETED   | Fully implemented with SQL Server      |
| 3D Thermal Visualization    | Not Started | Requires Three.js integration          |
| Forecast/Prediction Models  | PARTIAL     | Electricity consumption + generation forecast implemented |
| Period Comparison (YoY/PoP) | Not Started | Requires historical data analysis      |
| AI Chatbot (EVA)            | Not Started | Requires Google Gemini API integration |
| Quiz System                 | Not Started | Requires QR code generation            |
| Dashboard Management        | Not Started | Admin configuration interface          |

---

## 8. Key Differences from Original Plan

### 8.1 Architecture Approach

| Aspect           | Planned                                            | Actual                               | Reason                                        |
| ---------------- | -------------------------------------------------- | ------------------------------------ | --------------------------------------------- |
| Code Structure   | Class-based OOP (following class diagram)          | Functional with Hooks and Services   | React ecosystem favors functional programming |
| Model Layer      | Separate Model classes (User, Admin, Report, etc.) | Service layer with utility functions | Simpler and more maintainable for React       |
| State Management | Redux or Context API                               | Context API only                     | Project size doesn't require Redux complexity |

### 8.2 Data Strategy

| Aspect      | Planned                        | Actual                            | Reason                                |
| ----------- | ------------------------------ | --------------------------------- | ------------------------------------- |
| Database    | Immediate SQL Server migration | Gradual migration (Thermal first) | Risk mitigation, one module at a time |
| Data Format | Direct SQL queries             | Mock JSON + SQL Server            | Client data structure not finalized   |

### 8.3 Authentication Strategy

| Aspect           | Planned        | Actual                         | Reason                                    |
| ---------------- | -------------- | ------------------------------ | ----------------------------------------- |
| Auth Method      | JWT tokens     | Session-based (sessionStorage) | Simplified for prototype phase            |
| Password Storage | bcrypt hashing | Plain text                     | Security deferred to final implementation |
| Firebase         | Not planned    | Installed but not active       | Prepared for future use                   |

### 8.4 Implementation Priority

| Aspect                  | Planned       | Actual                  | Reason                                |
| ----------------------- | ------------- | ----------------------- | ------------------------------------- |
| Thermal Dashboard       | P2 (skeleton) | P0 (fully implemented)  | Used as SQL Server integration pilot  |
| Authentication Security | P0            | Deferred to final phase | Focus on core business features first |

---

## 9. Design Decisions and Rationale

### 9.1 Why Gradual Database Migration?

**Decision**: Migrate one module at a time to SQL Server instead of all at once

**Rationale**:

- Lower risk of system-wide failures
- Thermal module serves as pilot implementation
- Client's SQL Server data structure still being finalized
- Easier to debug and troubleshoot issues
- Team can learn from first migration before scaling

**Current Status**: Thermal successfully migrated, others pending

---

### 9.2 Why Session-based Auth Instead of JWT?

**Decision**: Use simple sessionStorage instead of JWT tokens

**Rationale**:

- Prototype phase prioritizes functionality over security
- Faster development without token management complexity
- Sufficient for development and demonstration purposes
- JWT and Firebase will be implemented in final phase
- Focus resources on core business features first

**Future Plan**: Implement JWT + Firebase authentication in final phase

---

### 9.3 Why No Model Classes?

**Decision**: Use functional programming with Hooks and Services instead of OOP classes

**Rationale**:

- React ecosystem strongly favors functional components and Hooks
- Hooks provide better code reusability and composition
- Service layer pattern is cleaner for API calls
- Easier to test and maintain
- Class diagram serves as design reference, not implementation mandate

**Actual Pattern**:

- Custom Hooks for state logic (useAuth, useThermalData, etc.)
- Service classes for API calls (UserService, ElectricityService, etc.)
- Functional components for UI
- Context API for global state

---

### 9.4 Why Implement Thermal Dashboard Early?

**Decision**: Fully implement Thermal Dashboard (P2) before Electricity Dashboard (P1)

**Rationale**:

- Needed a pilot module for SQL Server integration
- Thermal data structure was ready and available
- Could validate database connection approach
- Lessons learned applied to future modules
- Demonstrates full-stack capability early

**Result**: Successful SQL Server integration, reusable patterns established

---

### 9.5 Why Mock Data for User Management?

**Decision**: Continue using Mock JSON data for Users and Login Logs

**Rationale**:

- Focus on core business features (data dashboards) first
- User management is administrative, not core functionality
- Authentication security will be enhanced in final phase
- Allows rapid development without database dependencies
- Easy to reset and test with controlled data
- No database permission or connection issues

**Migration Plan**: Migrate Users and Login Logs to SQL Server in next sprint with proper security (bcrypt, JWT)

---

## 10. Current Architecture (Actual Implementation)

### 10.1 Frontend Architecture

**Pattern**: Functional Components + Custom Hooks + Service Layer

```
Frontend Structure:
‚îú‚îÄ‚îÄ components/          (UI Components)
‚îÇ   ‚îú‚îÄ‚îÄ CarbonFootprint/ (Carbon-specific components)
‚îÇ   ‚îú‚îÄ‚îÄ Thermal/         (Thermal-specific components)
‚îÇ   ‚îú‚îÄ‚îÄ UserManagement/  (User management components)
‚îÇ   ‚îú‚îÄ‚îÄ Common/          (Reusable components)
‚îÇ   ‚îî‚îÄ‚îÄ Layout/          (Layout components: Sidebar, AIChatbot)
‚îÇ
‚îú‚îÄ‚îÄ pages/               (Container components, route-level)
‚îÇ   ‚îú‚îÄ‚îÄ LoginPage.jsx
‚îÇ   ‚îú‚îÄ‚îÄ DashboardPage.jsx
‚îÇ   ‚îú‚îÄ‚îÄ UserManagementPage.jsx
‚îÇ   ‚îú‚îÄ‚îÄ CarbonFootprintPage.jsx
‚îÇ   ‚îú‚îÄ‚îÄ ThermalPage.jsx
‚îÇ   ‚îî‚îÄ‚îÄ ComingSoonPage.jsx
‚îÇ
‚îú‚îÄ‚îÄ contexts/            (Global state management)
‚îÇ   ‚îî‚îÄ‚îÄ AuthContext.jsx  (Authentication state)
‚îÇ
‚îú‚îÄ‚îÄ hooks/               (Custom React Hooks)
‚îÇ   ‚îî‚îÄ‚îÄ useAuth.js       (Authentication hook)
‚îÇ
‚îú‚îÄ‚îÄ lib/                 (Utilities and domain-specific logic)
‚îÇ   ‚îú‚îÄ‚îÄ constants/       (Constants definitions)
‚îÇ   ‚îî‚îÄ‚îÄ hooks/           (Domain-specific hooks: useThermalData, etc.)
‚îÇ
‚îú‚îÄ‚îÄ services/            (API communication layer)
‚îÇ   ‚îú‚îÄ‚îÄ UserService.js
‚îÇ   ‚îú‚îÄ‚îÄ ElectricityService.js
‚îÇ   ‚îú‚îÄ‚îÄ ElectricityMapsService.js
‚îÇ   ‚îú‚îÄ‚îÄ ThermalService.js
‚îÇ   ‚îú‚îÄ‚îÄ LoginLogService.js
‚îÇ   ‚îî‚îÄ‚îÄ FirebaseAuthService.js (prepared, not active)
‚îÇ
‚îî‚îÄ‚îÄ App.jsx              (Main routing and layout)
```

**Key Patterns**:

- Container/Presentation component separation
- Custom Hooks for complex state logic
- Service layer for all API calls
- Context API for authentication state
- Protected routes with role-based access

---

### 10.2 Backend Architecture

**Pattern**: Routes ‚Üí Controllers ‚Üí Services ‚Üí Data

```
Backend Structure:
‚îú‚îÄ‚îÄ routes/              (API endpoint definitions)
‚îÇ   ‚îú‚îÄ‚îÄ userRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ electricityRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ thermalRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ loginLogRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ databaseTestRoutes.js
‚îÇ   ‚îî‚îÄ‚îÄ firebaseAuthRoutes.js (prepared, not active)
‚îÇ
‚îú‚îÄ‚îÄ controllers/         (Request handling and response)
‚îÇ   ‚îú‚îÄ‚îÄ userController.js
‚îÇ   ‚îú‚îÄ‚îÄ electricityController.js
‚îÇ   ‚îú‚îÄ‚îÄ thermalController.js
‚îÇ   ‚îú‚îÄ‚îÄ loginLogController.js
‚îÇ   ‚îî‚îÄ‚îÄ firebaseAuthController.js (prepared, not active)
‚îÇ
‚îú‚îÄ‚îÄ services/            (Business logic and data operations)
‚îÇ   ‚îú‚îÄ‚îÄ userService.js
‚îÇ   ‚îú‚îÄ‚îÄ electricityService.js
‚îÇ   ‚îú‚îÄ‚îÄ thermalService.js
‚îÇ   ‚îî‚îÄ‚îÄ loginLogService.js
‚îÇ
‚îú‚îÄ‚îÄ db/                  (Database utilities)
‚îÇ   ‚îî‚îÄ‚îÄ sqlcmdQuery.js   (SQL Server query helper)
‚îÇ
‚îú‚îÄ‚îÄ firebase/            (Firebase configuration)
‚îÇ   ‚îî‚îÄ‚îÄ admin.js         (prepared, not active)
‚îÇ
‚îú‚îÄ‚îÄ config/              (Configuration)
‚îÇ   ‚îú‚îÄ‚îÄ config.js        (Environment and paths)
‚îÇ   ‚îî‚îÄ‚îÄ database.js      (Database configuration and constants)
‚îÇ
‚îî‚îÄ‚îÄ server.js            (Express server entry point)
```

**Key Patterns**:

- RESTful API design
- Layered architecture (separation of concerns)
- Centralized configuration (database.js eliminates magic strings/numbers)
- Centralized error handling
- CORS configuration for Vercel deployment
- Environment-based configuration

---

### 10.3 Data Flow

```
User Action (Frontend)
    ‚Üì
UI Component (React)
    ‚Üì
Custom Hook (if complex state)
    ‚Üì
Service Layer (API call)
    ‚Üì
HTTP Request (fetch)
    ‚Üì
Backend Route
    ‚Üì
Controller (request validation)
    ‚Üì
Service (business logic)
    ‚Üì
Data Source (Mock JSON or SQL Server)
    ‚Üì
Response (JSON)
    ‚Üì
Service Layer (Frontend)
    ‚Üì
State Update (Hook or Context)
    ‚Üì
UI Re-render
```

---

### 10.4 Authentication Flow

```
1. User enters credentials ‚Üí LoginPage
2. LoginPage calls UserService.authenticate()
3. Backend validates against users.json
4. If valid, create login log entry
5. Return user object with lastLoginId
6. Frontend stores in sessionStorage
7. AuthContext provides user state globally
8. Protected routes check authentication
9. Sidebar filters by user permissions
10. Auto-logout after 30 minutes of inactivity
```

---

### 10.5 Database Connection (Thermal Module)

```
Frontend Request
    ‚Üì
ThermalService.js (API call)
    ‚Üì
Backend thermalRoutes.js
    ‚Üì
thermalController.js
    ‚Üì
thermalService.js
    ‚Üì
sqlcmdQuery.js (executes sqlcmd command)
    ‚Üì
SQL Server (TestSlimDB database)
    ‚Üì
Returns data
    ‚Üì
Response to frontend
```

**SQL Server Configuration**:

- Server: `.\SQLEXPRESS` (SQL Server Express instance)
- Database: TestSlimDB
- Authentication: Windows Authentication (default)
- Query Tool: sqlcmd command-line utility with `-C` flag (trust certificate)
- Configuration: Centralized in `config/database.js`

---

## 11. Quick Facts for AI

**Project Basics**:

- Project Name: EcoSphere
- Type: Smart Building Analytics System
- Client: SAIT GBTAC (Green Building Technology Access Centre)
- Development Phase: Phase 3 - Small System Prototype
- Timeline: 15 weeks (Jan 6 - Apr 17, 2026)

**Technical Stack**:

- Frontend: React 19.2.0 + Vite + Material-UI 7.3.5
- Backend: Node.js + Express 5.1.0
- Database: Mock JSON (transitioning to SQL Server)
- Charts: Chart.js 4.5.1
- Authentication: Session-based (JWT planned for later)

**Progress Summary**:

- Total Planned Modules: 10
- Completed Modules: 6 (Login, User Management, Carbon Footprint, Electricity, Thermal, Water)
- Partially Completed: 1 (Forecast - Electricity only)
- In Progress: 0
- Not Started: 3
- Overall Completion: ~70% (P0 complete, P1 complete, P2 75%)

**Data Sources**:

- SQL Server: 4 modules (Thermal, Electricity, Water, Carbon Footprint)
- Mock JSON: 2 modules (Users, Login Logs)
- External API: 1 (Electricity Maps for historical carbon intensity)

**Code Statistics**:

- Frontend Pages: 9 (added OverviewPage)
- Frontend Services: 8 (added ForecastService)
- Backend Routes: 8 (added forecastRoutes)
- Backend Controllers: 7 (added forecastController)
- Backend Services: 6 (added forecastService)
- Custom Hooks: 10+ (added useForecastData)
- Carbon Footprint Components: 3 (TimePresetSelector, AutomaticCalculationView, CustomCalculator)
- Overview Components: 7 (TimePresetSelector, 3 module overviews, 3 common components)
- Electricity Components: 16 (7 shared + 3 consumption + 2 generation + 1 net energy + 3 forecast)
- Water Components: 3 (1 shared TimeFilter + 2 tabs)

**Deployment**:

- Frontend: Vercel-ready
- Backend: Vercel-ready (serverless export)
- CORS: Configured for production URLs

**Test Accounts**:

- 3 users in system (1 SuperAdmin, 1 Admin, 1 TeamMember)
- All use password: abcd1234

---

## 12. Next Priorities

### Immediate Next Steps (Priority Order)

1. **User Management Migration to SQL Server** (NEXT PRIORITY)

   - Update: Migrate Users and Login Logs from Mock JSON to SQL Server
   - Enhancement: Implement proper password hashing (bcrypt)
   - Security: Add JWT token authentication
   - Timeline: Next sprint

2. **Advanced Dashboard Features**

   - Period comparison (YoY/PoP) for Electricity, Thermal, Water
   - Self-sufficiency rate visualization for Electricity
   - Advanced analytics and forecasting
   - Timeline: Future enhancement

### Future Phases

**Phase 1: Core Dashboards** (COMPLETED)

- ‚úÖ Complete Electricity Dashboard
- ‚úÖ Implement Water Dashboard
- ‚úÖ Migrate Electricity to SQL Server
- ‚úÖ Migrate Water to SQL Server
- ‚úÖ Migrate Carbon Footprint to SQL Server
- ‚úÖ Integrate historical carbon intensity API

**Phase 2: Advanced Features** (Weeks 11-12)

- AI Chatbot (Google Gemini API)
- Forecast/Prediction models
- Period comparison (YoY/PoP)
- 3D Thermal Visualization

**Phase 3: Security and Polish** (Weeks 13-15)

- Implement JWT authentication
- Integrate Firebase
- Password encryption (bcrypt)
- Security audit
- Performance optimization

---

## 13. Important Technical Decisions

### 13.1 Timezone Handling Strategy (Defensive Programming)

**Context**: 
- Database stores all timestamps in **Calgary local time** (MST/MDT, UTC-7/-6)
- Application is designed to run in Calgary timezone
- No timezone information stored in database timestamps

**Challenge**:
When creating JavaScript Date objects from date strings (e.g., `new Date('2020-11-08')`), different browsers may interpret the string differently:
- Some browsers treat it as local time: `2020-11-08 00:00:00 MST`
- Others treat it as UTC time: `2020-11-08 00:00:00 UTC` ‚Üí converts to `2020-11-07 17:00:00 MST` (previous day!)

**Solution - Defensive Programming Approach**:
To ensure consistent behavior across all browsers and prevent date boundary issues, we add `T12:00:00` (noon time) when creating Date objects from date strings:

```javascript
// ‚ùå RISKY - May cause date shift in some browsers
const date = new Date('2020-11-08');  // Could become 2020-11-07 in Calgary

// ‚úÖ SAFE - Noon time prevents date boundary crossing
const date = new Date('2020-11-08T12:00:00');  // Always 2020-11-08 regardless of timezone
```

**Why Noon Time (12:00:00)?**
- Even if browser applies timezone conversion, noon time won't cross date boundaries
- Calgary is UTC-7, so worst case: `2020-11-08 12:00:00 UTC` ‚Üí `2020-11-08 05:00:00 MST` (still same day)
- Provides safety margin for any timezone interpretation

**Implementation Locations**:
- Frontend date formatting: `ElectricityReportService.js`, `WaterReportService.js`, `useThermalData.js`
- Frontend date pickers: `ElectricityReportPage.jsx`, `WaterReportPage.jsx`, `ThermalPage.jsx`, `TimeFilter.jsx`
- Backend date validation: `electricityController.js`, `waterController.js` (uses string comparison instead of Date objects)

**Key Principle**:
Always use **local time methods** (`getFullYear()`, `getMonth()`, `getDate()`) instead of UTC methods (`getUTCFullYear()`, etc.) since database times are local Calgary time.

**Benefits**:
1. **Browser Compatibility**: Works consistently across all browsers
2. **Future-Proof**: If someone accesses the app from a different timezone, dates still display correctly
3. **Defensive**: Prevents subtle bugs from timezone edge cases
4. **Maintainable**: Clear pattern for all date handling in the codebase

**Database Date Ranges** (Verified 2026-01-04):
- **Electricity** (TL339, TL340, TL341): 2019-02-13 to 2020-11-08
- **Thermal** (SaitSolarLab_20004_TL2): 2019-01-01 to 2020-11-08
- **Water - Rainwater** (TL93): 2018-10-13 to 2020-11-08
- **Water - Hot Water** (TL210): 2018-09-11 to 2019-11-14

---

## 14. Known Limitations and Technical Debt

### Current Limitations

1. **Authentication Security**

   - Plain text password storage (Users still in Mock JSON)
   - No password reset functionality
   - No email verification
   - Session-based only (no token refresh)
2. **Data Persistence**

   - User Management uses Mock JSON (not scalable)
   - Custom Calculator data not persisted
   - Login logs in JSON (should be in database)
3. **Error Handling**

   - Basic error messages
   - No centralized error logging
   - Limited user feedback on failures
4. **Testing**

   - No unit tests implemented
   - No integration tests
   - No E2E tests
   - Manual testing only
5. **Performance**

   - No data pagination
   - No lazy loading for large datasets
   - Limited caching strategy (only Electricity Maps API)

### Technical Debt

1. **Code Organization**

   - Some components exceed 150 lines (e.g., CarbonFootprintPage.jsx)
   - Duplicate code in export functionality
   - Inconsistent error handling patterns
2. **Documentation**

   - Limited inline code comments
   - No API documentation (Swagger/OpenAPI)
   - No component documentation (Storybook)
3. **Configuration**

   - Hardcoded API URLs in some places
   - Environment variables not fully utilized
   - No configuration validation
4. **Accessibility**

   - Limited ARIA labels
   - No keyboard navigation testing
   - No screen reader testing

---

## 15. Backend Code Standards and Refactoring (2026-01-05)

### 15.1 Backend Development Standards Established

**Purpose**: Establish consistent coding patterns and improve maintainability across backend codebase

**Key Principles**:
1. **No Magic Numbers/Strings**: All constants centralized in configuration files
2. **DRY (Don't Repeat Yourself)**: Extract common patterns into reusable utilities
3. **Consistent Error Handling**: Use helper functions for try-catch blocks
4. **Input Validation**: Validate all user inputs before processing
5. **Declarative/Configuration-Driven**: Prefer configuration over imperative code
6. **Code Size Limits**: Controllers < 150 lines, Functions < 50 lines

### 15.2 Backend Refactoring Completed

**Modules Refactored**:
1. **Electricity Controller** (`electricityController.js`)
   - Before: 305 lines
   - After: 147 lines (52% reduction)
   - Improvements: Used `asyncHandler`, `createDataFetcher`, `createBreakdownDataFetcher`

2. **Water Controller** (`waterController.js`)
   - Before: 105 lines
   - After: 66 lines (37% reduction)
   - Improvements: Used `asyncHandler`, `createDataFetcher`

3. **Thermal Controller** (`thermalController.js`)
   - Before: 155 lines
   - After: 139 lines (10% reduction)
   - Improvements: Lightweight refactoring, extracted constants and validation

**New Utility Files Created**:

1. **`utils/controllerHelper.js`** (Backend Helper Utilities)
   - `asyncHandler(fn)`: Automatic error handling wrapper for async functions
   - `createDataFetcher(options)`: Generic data fetcher with validation and error handling
   - `createBreakdownDataFetcher(options)`: Multi-source data fetcher for breakdown views
   - `validateParams(params)`: Parameter validation middleware

2. **`utils/thermalConstants.js`** (Thermal-Specific Constants)
   - Floor definitions and sensor mappings
   - Time interval constants
   - Error messages
   - Eliminates all magic numbers/strings from thermal controller

3. **`utils/thermalValidation.js`** (Thermal Validation Functions)
   - `validateFloor(floor)`: Floor parameter validation
   - `validateDateRange(dateFrom, dateTo)`: Date range validation
   - `validateTimeIndex(timeIndex)`: Time index validation
   - Centralized validation logic

4. **`utils/weatherConstants.js`** (Weather API Configuration)
   - Open-Meteo API endpoints
   - Calgary location coordinates
   - Weather variables list
   - Training period configuration
   - Error messages

**Benefits Achieved**:
- **Improved Maintainability**: Easier to understand and modify code
- **Reduced Duplication**: Common patterns extracted to utilities
- **Better Error Handling**: Consistent error responses across all endpoints
- **Easier Testing**: Smaller, focused functions are easier to test
- **Scalability**: Patterns can be reused for future modules (Water, Thermal forecasts)

### 15.3 Weather Service Integration

**New Service**: `services/weatherService.js`

**Features**:
- Fetches historical weather data from Open-Meteo Archive API
- Fetches weather forecast from Open-Meteo Forecast API
- Automatic selection between historical and forecast data
- Daily aggregation of hourly weather data
- Weather variables: Direct radiation, temperature, cloud cover, shortwave radiation, diffuse radiation

**API Integration**:
- Provider: Open-Meteo (open-meteo.com)
- Free tier with historical data access
- Location: Calgary, AB (51.0947¬∞N, 114.1094¬∞W)
- Timezone: America/Edmonton (MST/MDT)

**Methods**:
- `getHistoricalWeather(dateFrom, dateTo)`: Fetch historical weather
- `getForecastWeather(dateFrom, dateTo)`: Fetch weather forecast
- `getWeatherData(dateFrom, dateTo)`: Auto-select historical or forecast
- `aggregateToDaily(weatherData)`: Aggregate hourly to daily

### 15.4 Forecast Service Enhancements

**Updated Service**: `services/forecastService.js`

**New Methods for Generation Forecast**:
- `generateGenerationForecast()`: Main entry point for generation prediction
- `trainWeatherModel()`: Train simple linear regression model
- `predictWithWeatherModel()`: Generate predictions using trained model

**Model Details**:
- **Algorithm**: Simple Linear Regression
- **Formula**: `Generation = a √ó Direct_Radiation + b`
- **Training**: 60 days of historical data
- **Predictor**: Direct solar radiation (strongest correlation: 0.80)
- **Why Simple**: Temperature coefficient was unreliable in multi-variable model

**Analysis Scripts Created**:
- `scripts/analyze-weather-correlation.js`: 7-day correlation analysis
- `scripts/analyze-weather-correlation-60days.js`: 60-day correlation analysis
- Results: Direct radiation has strongest correlation (r=0.80) with generation

---

## 16. Reference Documents

### Planning Documents

- **Project Introduction**: `1.EcoSphereIntroduction.md` - Full project background, requirements, and 15-week timeline
- **Implementation Plan**: `2.IMPLEMENTATION_PLAN-cn.md` - Detailed implementation plan with class definitions and API design
- **Architecture Design**: `3.ARCHITECTURE-cn.md` - Original architecture design and technical decisions
- **Current State**: `4.CURRENT_STATE.md` - This document
- **Forecast Implementation Checklist**: `FORECAST_IMPLEMENTATION_CHECKLIST.md` - Detailed guide for implementing forecast features in other modules

### Database Analysis Documents

- **Electricity Tables Analysis (English)**: `.documentation/ReadMeBeforeStart/electricity/ELECTRICITY_TABLES_ANALYSIS_EN.md` - Comprehensive analysis of 21 electricity database tables, including table relationships, data classification, and implementation recommendations
- **Electricity Tables Analysis (Chinese)**: `.documentation/ReadMeBeforeStart/electricity/ELECTRICITY_TABLES_ANALYSIS_CN.md` - Chinese version of the electricity database analysis

### External References

- Class Diagram: `instructions/ref/class-diagram-optimized.puml`
- ERD Diagram: `instructions/ref/erd-diagram.puml`
- Sequence Diagrams: `deliverables/seq-*.puml`
- Activity Diagrams: `deliverables/activity-*.puml`

### Code Locations

- Frontend: `ecosphere-frontend/src/`
- Backend: `ecosphere-backend/`
- Mock Data: `mock-data/` (only users.json and loginLogs.json remain)
- Documentation: `.documentation/`

### Key Configuration Files

- **Database Configuration**: `ecosphere-backend/config/database.js`
  - Centralized database constants (table names, query parameters, time constants)
  - sqlcmd path detection and command building
  - Eliminates magic strings/numbers throughout codebase
  - Single source of truth for all database-related configuration
  
- **Environment Variables**: `ecosphere-backend/.env`
  - `DB_SERVER=.\SQLEXPRESS` (SQL Server instance)
  - `DB_DATABASE=TestSlimDB`
  - Windows Authentication (no credentials needed)

---

## Document Maintenance

**How to Update This Document**:

1. Update after completing each major feature
2. Update when making architectural changes
3. Update when deviating from original plan
4. Keep "Last Updated" date current
5. Maintain accuracy - only document what actually exists

---

**End of Document**
