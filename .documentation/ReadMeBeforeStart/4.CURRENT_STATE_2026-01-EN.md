# EcoSphere Project - Current State Document

**Document Version**: 2026-01-07 (Updated: Performance Optimization)  
**Project Phase**: Phase 3 - Small System Prototype  
**Target Audience**: Development Team and AI Assistants  
**Historical Document**: See `4.CURRENT_STATE.md` for detailed evolution history

---

## 1. Project Overview

**Project Name**: EcoSphere - Smart Building Analytics System  
**Client**: SAIT GBTAC (Green Building Technology Access Centre)  
**Development Timeline**: 15 weeks (Jan 6 - Apr 17, 2026)  
**Current Progress**: P0 100% | P1 100% | P2 90%

### 1.1 Core Features Status

| Module | Status | Completion | Data Source |
|--------|--------|------------|-------------|
| Login System | ✅ Complete | 100% | Mock JSON |
| User Management | ✅ Complete | 100% | Mock JSON |
| Carbon Footprint Tracking | ✅ Complete | 100% | SQL Server + API |
| Electricity Dashboard | ✅ Complete | 100% | SQL Server |
| Water Dashboard | ✅ Complete | 100% | SQL Server |
| Thermal Dashboard | ✅ Complete | 100% | SQL Server |
| Overview Dashboard | ✅ Complete | 100% | SQL Server |
| Forecast Features | ✅ Complete | 90% | SQL Server + API |
| 3D Visualization | ⏳ Not Started | 0% | - |
| AI Chatbot | ⏳ Not Started | 0% | - |
| Quiz System | ⏳ Not Started | 0% | - |

---

## 2. Technology Stack

### 2.1 Frontend Technologies
- **Framework**: React 19.2.0
- **Build Tool**: Vite 7.2.4
- **UI Library**: Material-UI 7.3.5
- **Routing**: React Router 7.9.6
- **Charts**: Chart.js 4.5.1 + react-chartjs-2 5.3.1
- **Date Handling**: date-fns 4.1.0
- **PDF Export**: jsPDF 3.0.4 + html2canvas 1.4.1

### 2.2 Backend Technologies
- **Runtime**: Node.js
- **Framework**: Express 5.1.0
- **Database**: SQL Server Express (TestSlimDB)
- **Database Tool**: sqlcmd (command-line query)
- **Database Connection**: mssql 12.2.0 (connection pool with sqlcmd fallback)
- **Time Series Analysis**: timeseries-analysis 1.0.12
- **Performance**: In-memory caching, rate limiting
- **Others**: cors 2.8.5, dotenv 17.2.3, body-parser 2.2.1

### 2.3 External API Integration
- **Electricity Maps API**: Historical carbon intensity data (Alberta, CA-AB)
- **Open-Meteo API**: Weather data (historical and forecast)
  - For generation forecast (solar radiation)
  - For rainwater forecast (precipitation)
  - For thermal forecast (outdoor temperature)

---

## 3. Database Configuration

### 3.1 SQL Server Connection
```
Server: .\SQLEXPRESS
Database: TestSlimDB
Authentication: Windows Authentication
Database Location: C:\XW\SAIT\GB\
- TestSlimDB.mdf (main data file)
- TestSlimDB_log.ldf (log file)
```

### 3.2 Database Tables Overview

#### Electricity Module Tables
| Table Name | Purpose | Data Range | Interval |
|------------|---------|------------|----------|
| TL341 | Consumption (Hourly Increment) | 2019-02-13 to 2020-11-08 | 1 hour |
| TL340 | Generation (Hourly Increment) | 2019-02-13 to 2020-11-08 | 1 hour |
| TL339 | Net Energy (Hourly Increment) ⚠️ | 2019-02-13 to 2020-11-08 | 1 hour |
| TL342 | Three-Phase Total Power | 2020-11-01 to 2020-11-08 | 1 minute |
| TL343 | Phase A Power | 2020-11-01 to 2020-11-08 | 1 minute |
| TL344 | Phase B Power | 2020-11-01 to 2020-11-08 | 1 minute |
| TL345 | Phase C Power | 2020-11-01 to 2020-11-08 | 1 minute |
| TL213 | Panel2A-1 Equipment | 2020-02-15 to 2020-11-08 | 1 minute |
| TL4 | Ventilation Equipment | 2020-11-01 to 2020-11-08 | 1 minute |
| TL209 | Lighting Equipment | 2019-11-07 to 2019-11-14 | 1 minute |
| TL211 | Equipment Power | 2019-11-07 to 2019-11-14 | 1 minute |
| TL212 | Appliances Power | 2019-11-07 to 2019-11-14 | 1 minute |
| TL252 | Solar - Carport | 2020-11-01 to 2020-11-08 | 1 minute |
| TL253 | Solar - Rooftop | 2020-11-01 to 2020-11-08 | 1 minute |

**⚠️ Important Note**: TL339 (Net Energy) data is inaccurate. System uses frontend calculation: `Net Energy = TL340 (Generation) + TL341 (Consumption)`

#### Water Module Tables
| Table Name | Purpose | Data Range | Interval |
|------------|---------|------------|----------|
| TL93 | Rainwater Level (%) | 2018-10-13 to 2020-11-08 | 10 minutes |
| TL210 | Hot Water Consumption (L/h) | 2018-09-11 to 2019-11-14 | 1 minute |

#### Thermal Module Tables
| Sensor ID | Location | Data Range | Interval |
|-----------|----------|------------|----------|
| 20004_TL2 | Basement | 2019-01-01 to 2020-11-08 | 15 minutes |
| 20005_TL2 | Basement | 2019-01-01 to 2020-11-08 | 15 minutes |
| 20006_TL2 | Basement | 2019-01-01 to 2020-11-08 | 15 minutes |
| 20007_TL2 | Level 1 | 2019-01-01 to 2020-11-08 | 15 minutes |
| 20008_TL2 | Level 1 | 2019-01-01 to 2020-11-08 | 15 minutes |
| 20009_TL2 | Level 1 | 2019-01-01 to 2020-11-08 | 15 minutes |
| 20010_TL2 | Level 1 | 2019-01-01 to 2020-11-08 | 15 minutes |
| 20011_TL2 | Level 1 | 2019-01-01 to 2020-11-08 | 15 minutes |
| 20012_TL2 | Level 2 | 2019-01-01 to 2020-11-08 | 15 minutes |
| 20013_TL2 | Level 2 | 2019-01-01 to 2020-11-08 | 15 minutes |
| 20014_TL2 | Level 2 | 2019-01-01 to 2020-11-08 | 15 minutes |
| 20015_TL2 | Level 2 | 2019-01-01 to 2020-11-08 | 15 minutes |
| 20016_TL2 | Level 2 | 2019-01-01 to 2020-11-08 | 15 minutes |

**Floor Sensor Distribution**:
- Basement: 3 sensors (20004-20006)
- Level 1: 5 sensors (20007-20011)
- Level 2: 5 sensors (20012-20016)

---

## 4. Core Features Details

### 4.1 Login & User Management

**Authentication Method**: Session-based (using sessionStorage)  
**Session Timeout**: 30 minutes auto-logout  
**Data Source**: Mock JSON (`data/users.json`, `data/loginLogs.json`)

**Test Accounts**:
```
Super Admin: super.admin@edu.sait.ca / abcd1234
Admin: xujun.wang@edu.sait.ca / abcd1234
Team Member: test.member@edu.sait.ca / abcd1234
```

**User Roles**:
- SuperAdmin: Full permissions, cannot be deleted
- Admin: Management permissions
- TeamMember: View permissions

**Permission Types**:
- electricity
- water
- thermal
- 3d-model
- carbon-footprint

**Key Files**:
- Frontend: `LoginPage.jsx`, `AuthContext.jsx`, `UserManagementPage.jsx`
- Backend: `userRoutes.js`, `userController.js`, `userService.js`
- Services: `LoginLogService.js`

### 4.2 Carbon Footprint Tracking Module

**Two Calculation Modes**:

#### Mode 1: Automatic Calculation (from Database)
- Data Source: TL341 (Consumption) + Electricity Maps API (Carbon Intensity)
- Time Presets: Today, Yesterday, Last 7 Days, Last 30 Days, Custom
- Demo Date Baseline: November 2020 (available data range)
- Display Logic:
  - Single day: 24 hourly data points
  - Multiple days: Daily aggregated data points
- Carbon Intensity: Uses historical carbon intensity for each date
- Calculation Formula: `CO2 = Energy(kWh) × Carbon Intensity(kg CO2/kWh)`

#### Mode 2: Custom Calculator (User Upload)
- User inputs electricity bills (year, month, usage)
- Real-time calculation, not persisted
- Uses average carbon intensity (from historical data)
- Data validation (no duplicates, no future dates)

**Visualization**:
- Chart.js line chart (Energy + Carbon on dual Y-axis)
- Metrics cards (Total, Average)
- Interactive tooltips
- PDF export feature

**Key Files**:
- Frontend: `CarbonFootprintPage.jsx`, `AutomaticCalculationView.jsx`, `CustomCalculator.jsx`
- Backend: `electricityRoutes.js`, `electricityController.js`
- Services: `ElectricityReportService.js`, `ElectricityMapsService.js`

---

### 4.3 Electricity Dashboard

**Four Main Tabs**:

#### 1. Consumption Tab
- Overall trend chart (hourly data)
- Key metrics: Total, Average, Peak, Min
- Breakdown views:
  - Overall
  - By Phase (A/B/C three-phase)
  - By Equipment (Panel2A-1, Ventilation, Lighting, Equipment, Appliances)

#### 2. Generation Tab
- Overall trend chart (hourly data)
- Key metrics: Total, Average, Peak, Min
- Breakdown views:
  - Overall
  - By Solar Source (Carport vs Rooftop) pie chart

#### 3. Net Energy Tab
- Trend chart (preserves positive/negative values)
- Key metrics (red=negative, green=positive)
- Status indicators (Net Consumer vs Net Producer)
- **Self-Sufficiency Rate Analysis** (Added 2026-01-07):
  - Average self-sufficiency rate metric card
  - Dual Y-axis chart: Net Energy + Self-Sufficiency Rate trend
  - 100% reference line
  - Formula: `Self-Sufficiency Rate = (Generation / |Consumption|) × 100%`
  - ⚠️ Frontend calculation (not using TL339 database values)

#### 4. Forecast Tab
- **Consumption Forecast**: Four-tier algorithm system
  - Tier 1: Holt-Winters Seasonal Smoothing (90% confidence)
  - Tier 2: Seasonal Weighted Prediction (80% confidence)
  - Tier 3: Trend-Based Prediction (65% confidence)
  - Tier 4: Moving Average (50% confidence)
- **Generation Forecast**: Weather-based linear regression model
  - Formula: `Generation = a × Direct_Radiation + b`
  - Training data: 60 days historical data
  - Weather variable: Direct radiation (correlation 0.80)
- Forecast periods: 7/14/30 days
- Data availability analysis
- Algorithm visualization grid

**Performance Optimization**:
- Hourly aggregation (consistent time intervals)
- Optimized SQL queries (DATEPART, 270x performance improvement)
- Auto-load data on tab switch

**Key Files**:
- Frontend Page: `ElectricityReportPage.jsx`
- Frontend Components: `ConsumptionTab.jsx`, `GenerationTab.jsx`, `NetEnergyTab.jsx`, `ForecastTab.jsx`
- Shared Components: `MetricsCards.jsx`, `OverallTrendChart.jsx`, `NetEnergyWithSelfSufficiencyChart.jsx`
- Backend: `electricityRoutes.js`, `electricityController.js`, `forecastController.js`
- Utils: `electricityCalculations.js` (Net Energy and Self-Sufficiency Rate calculations)

---

### 4.4 Water Dashboard

**Two Main Tabs**:

#### 1. Rainwater Harvesting Tab
- **Overview Sub-tab**:
  - Water level monitoring (%)
  - Historical data visualization
  - Key metrics: Current, Average, Peak, Min
- **Forecast Sub-tab** (Added 2026-01-06):
  - Weather-based linear regression model
  - Formula: `Daily Avg Water Level = a × Precipitation + b`
  - Training data: 60 days historical data
  - Forecast periods: 7/14/30 days
  - Output: Daily average water level (%)

#### 2. Hot Water Consumption Tab
- **Overview Sub-tab**:
  - Hot water usage (L/h)
  - Historical data visualization
  - Key metrics: Total, Average, Peak, Min
- **Forecast Sub-tab**:
  - Four-tier algorithm system (same as electricity consumption)
  - Forecast periods: 7/14/30 days

**Time Filter**:
- Presets: Last 7/30/90 days
- Custom date range

**Key Files**:
- Frontend: `WaterReportPage.jsx`, `RainwaterTab.jsx`, `HotWaterTab.jsx`
- Frontend Forecast: `RainwaterForecastView.jsx`, `HotWaterForecastView.jsx`
- Backend: `waterRoutes.js`, `waterController.js`, `forecastController.js`
- Services: `WaterReportService.js`, `weatherService.js`

---

### 4.5 Thermal Dashboard

**Three View Modes**:

#### 1. Single Day View
- Hourly data for selected date
- Outdoor temperature overlay (horizontal line)
- Time slider (96 fifteen-minute intervals)
- Play/pause animation

#### 2. Multiple Days View
- Aggregated data for date range
- Outdoor temperature overlay (High-Low range shading)
- Multi-day slider

#### 3. Forecast View (Added 2026-01-07)
- **Hybrid Model**: 80% Historical Baseline + 20% Weather Adjustment
- Training data: 60 days historical data
- Weather integration: Open-Meteo API outdoor temperature forecast
- Multi-sensor aggregation: Average all sensors per floor
- Forecast periods: 7/14/30 days
- Formula: `Indoor Temp = Historical Baseline + (Weather Coefficient × Outdoor Temp Change)`

**Floor Selection**: Basement, Level 1, Level 2

**Floor Plan Heat Map**:
- Real-time temperature overlay
- 8-level color coding (< 0°C to > 35°C)
- Multi-sensor support (3-5 sensors per floor)
- Outdoor temperature display (bottom-left corner, updates every 15 minutes)

**Temperature Color Coding**:
- < 0°C: Black (freezing)
- 0-20°C: Blue (cold)
- 20-22°C: Light Blue (cool)
- 22-23°C: Green (comfortable)
- 23-24°C: Yellow (warm)
- 24-25°C: Orange (hot)
- 25-35°C: Red (very hot)
- > 35°C: Purple (extreme heat)

**Key Files**:
- Frontend: `ThermalPage.jsx`, `ThermalControlPanel.jsx`, `ThermalFloorPlan.jsx`
- Frontend Forecast: `ThermalForecastView.jsx`, `ThermalForecastInfo.jsx`
- Backend: `thermalRoutes.js`, `thermalController.js`, `forecastController.js`
- Services: `ThermalService.js`, `WeatherService.js`

---

### 4.6 Overview Dashboard (Enhanced 2026-01-07)

**Unified View**: All three modules displayed on single page

**Time Presets**:
- Demo Day: 2020-11-01 to 2020-11-08 (8 days)
- Today, Yesterday, Last 7 Days
- No custom date picker (visit specific module pages for custom dates)

**Module Displays**:

#### Electricity Module
- Two-column card layout (Consumption, Generation) + full-width Net Energy card
- Reuses components: `MetricsCards`, `NetEnergyMetricsCards`, `OverallTrendChart`, `NetEnergyWithSelfSufficiencyChart`
- Displays Self-Sufficiency Rate with dual Y-axis chart
- Calculates Net Energy (not using database values)

#### Water Module
- Two-column card layout (Rainwater, Hot Water)
- Reuses components: `MetricsCards`, `OverallTrendChart`
- Consistent styling with Electricity module

#### Thermal Module
- Two-column layout (Basement, Level 1) + full-width Level 2 card
- Custom temperature statistics (Average, Max, Min)
- Fixed Y-axis range (15°C - 30°C) for easy comparison

**Data Aggregation**:
- Electricity: Frontend calculates Net Energy and Self-Sufficiency Rate (timestamp-based matching)
- Water: Single sensor (TL93 rainwater, TL210 hot water)
- Thermal: Multi-sensor averaging (average all sensors per floor)

**Compact Design**:
- Reduced font sizes and spacing
- Chart heights: 180px (Consumption/Generation/Water), 220px (Net Energy)
- No whitespace below charts
- Consistent card padding

**Key Files**:
- Frontend: `OverviewPage.jsx`
- Components: `ElectricityOverview.jsx`, `WaterOverview.jsx`, `ThermalOverview.jsx`
- Hooks: `useOverviewData.js` (enhanced with Net Energy calculation)
- Utils: `dataAggregation.js`, `electricityCalculations.js`

---

## 5. Project Architecture

### 5.1 Performance Optimization (Added 2026-01-07)

**Optimization Goal**: Support 50 concurrent users (20 actual users)

**Implemented Optimizations**:

#### 1. In-Memory Caching System
- **Location**: `utils/cache.js`
- **Strategy**: Simple in-memory cache (sufficient for 20-50 users, no Redis needed)
- **Cache TTL**:
  - Historical data: Infinity (never expires)
  - Recent data (< 7 days): 5 minutes
  - Date ranges: 24 hours
  - Forecast data: 1 hour
  - Weather data: Historical 24 hours, Forecast 1 hour
- **Cached Services**:
  - `electricityService.js`: All query methods
  - `waterService.js`: All query methods
  - `thermalService.js`: All query methods
  - `forecastService.js`: Consumption and generation forecasts
  - `weatherService.js`: Historical and forecast weather data
- **Cache Statistics**: Available at `/api/health` endpoint

#### 2. Rate Limiting
- **Location**: `middleware/rateLimiter.js`
- **Strategy**: In-memory rate limiter (per IP address)
- **Configuration**:
  - Time window: 60 seconds (1 minute)
  - Max requests: 200 per minute per IP (for load testing; adjust to 50-60 for production)
  - Response: HTTP 429 (Too Many Requests)
- **Protected Endpoints**:
  - `/api/forecast/*` (all forecast endpoints)
  - `/api/water/hot-water/forecast/*`
  - `/api/water/rainwater/forecast/*`
  - `/api/thermal/forecast/*`
- **Unprotected**: Login, data queries (no rate limit)
- **Statistics**: Available at `/api/health` endpoint

#### 3. Connection Pool with Fallback
- **Location**: `db/connectionManager.js`
- **Strategy**: Attempt connection pool, fallback to sqlcmd if fails
- **Connection Pool Configuration**:
  - Max connections: 10
  - Min connections: 2
  - Connection timeout: 15 seconds
  - Request timeout: 30 seconds
  - Idle timeout: 30 seconds
- **Fallback Mechanism**:
  - Tries to establish SQL Server connection pool on startup
  - If fails (TCP/IP disabled), automatically uses sqlcmd
  - Services continue using sqlcmd (proven reliable)
- **Why Fallback Works**:
  - SQL Server Express defaults: Named Pipes enabled, TCP/IP disabled
  - sqlcmd uses Named Pipes (works out of the box)
  - Connection pool requires TCP/IP (needs configuration)
  - Current implementation: sqlcmd + caching = sufficient performance
- **Status**: Available at `/api/health` endpoint

#### 4. PM2 Process Management (Optional)
- **Location**: `ecosystem.config.js`
- **Configuration**:
  - Cluster mode: 2 instances
  - Max memory restart: 500MB
  - Auto-restart on crash
  - Log management
  - Graceful shutdown
- **Usage**: For production deployment on customer server
- **Not Required**: For local development or Azure deployment

**Performance Test Results**:
- **Concurrent Users**: 50 users
- **Total Requests**: 250 requests
- **Success Rate**: 100% (with rate limit at 200/min)
- **Average Response Time**: 262ms
- **Throughput**: 130 req/s
- **Assessment**: ✅ Excellent - System handles load very well

**Load Testing Tool**:
- **Location**: `test-load.js`
- **Usage**: `node test-load.js` or run `test-concurrent.bat`
- **Configuration**: Adjustable concurrent users, requests per user, delay

### 5.2 Frontend Architecture

**Pattern**: Functional Components + Custom Hooks + Service Layer

```
src/
├── components/          # UI Components
│   ├── CarbonFootprint/ # Carbon footprint components
│   ├── Electricity/     # Electricity components
│   ├── Water/           # Water components
│   ├── Thermal/         # Thermal components
│   ├── Forecast/        # Forecast components (shared)
│   ├── Overview/        # Overview components
│   ├── Common/          # Reusable components
│   └── Layout/          # Layout components
├── pages/               # Page containers
├── contexts/            # Global state (AuthContext)
├── hooks/               # Custom Hooks
├── services/            # API communication layer
├── lib/                 # Utils and constants
│   ├── constants/       # Constant definitions
│   ├── hooks/           # Domain-specific Hooks
│   └── utils/           # Utility functions
└── App.jsx              # Main routing
```

**Key Patterns**:
- Container/Presentation component separation
- Custom Hooks for complex state logic
- Service layer for all API calls
- Context API for authentication state
- Role-based route protection

### 5.2 Backend Architecture

**Pattern**: Routes → Controllers → Services → Data

```
ecosphere-backend/
├── routes/              # API endpoint definitions
│   ├── userRoutes.js
│   ├── electricityRoutes.js
│   ├── waterRoutes.js
│   ├── thermalRoutes.js
│   ├── forecastRoutes.js
│   ├── weatherRoutes.js
│   └── loginLogRoutes.js
├── controllers/         # Request handling and response
├── services/            # Business logic and data operations
├── middleware/          # Express middleware
│   └── rateLimiter.js   # Rate limiting middleware
├── db/                  # Database utilities
│   ├── sqlcmdQuery.js   # SQL Server query helper
│   └── connectionManager.js  # Connection pool manager
├── config/              # Configuration
│   ├── database.js      # Database configuration (centralized)
│   └── config.js        # Environment configuration
├── utils/               # Utility functions
│   ├── cache.js         # In-memory caching system
│   ├── controllerHelper.js    # Controller helpers
│   ├── validationHelper.js    # Validation helpers
│   ├── responseHelper.js      # Response helpers
│   ├── forecastHelpers.js     # Forecast helpers
│   ├── thermalConstants.js    # Thermal constants
│   ├── forecastConstants.js   # Forecast constants
│   └── weatherConstants.js    # Weather constants
├── data/                # Mock data
│   ├── users.json
│   └── loginLogs.json
├── test-load.js         # Load testing tool
├── ecosystem.config.js  # PM2 configuration
└── server.js            # Express server entry point
```

**Key Patterns**:
- RESTful API design
- Layered architecture (separation of concerns)
- Centralized configuration (database.js eliminates magic strings/numbers)
- Centralized error handling
- In-memory caching for performance
- Rate limiting for API protection
- Connection pool with sqlcmd fallback
- CORS configuration (Vercel deployment)
- Environment-based configuration

### 5.3 Data Flow

```
User Action (Frontend)
    ↓
UI Component (React)
    ↓
Custom Hook (if complex state)
    ↓
Service Layer (API call)
    ↓
HTTP Request (fetch)
    ↓
Backend Route
    ↓
Rate Limiter (if forecast endpoint)
    ↓
Controller (request validation)
    ↓
Service (business logic)
    ↓
Cache Check (if cacheable)
    ↓ (cache miss)
Data Source (Mock JSON or SQL Server via sqlcmd)
    ↓
Cache Set (store result)
    ↓
Response (JSON)
    ↓
Service Layer (Frontend)
    ↓
State Update (Hook or Context)
    ↓
UI Re-render
```

---

## 6. Code Standards and Best Practices

### 6.1 Backend Code Standards (Established 2026-01-05)

**Core Principles**:
1. **No Magic Numbers/Strings**: All constants centralized in config files
2. **DRY Principle**: Extract common patterns to reusable utilities
3. **Consistent Error Handling**: Use helper functions for try-catch blocks
4. **Input Validation**: Validate all user inputs before processing
5. **Declarative/Configuration-Driven**: Prefer configuration over imperative code
6. **Code Size Limits**: Controllers < 150 lines, Functions < 50 lines

**Refactoring Results**:
- Electricity Controller: 305 lines → 147 lines (52% reduction)
- Water Controller: 105 lines → 66 lines (37% reduction)
- Thermal Controller: 155 lines → 139 lines (10% reduction)

**New Utility Files**:
- `utils/controllerHelper.js`: asyncHandler, createDataFetcher, createBreakdownDataFetcher
- `utils/validationHelper.js`: validateParams
- `utils/responseHelper.js`: sendSuccess, sendError
- `utils/thermalConstants.js`: Thermal-specific constants
- `utils/thermalValidation.js`: Thermal validation functions
- `utils/weatherConstants.js`: Weather API configuration

### 6.2 Frontend Code Standards

**Enterprise React Standards**:
- Components < 150 lines
- Hooks at the top
- Component reusability
- Centralized constants (no magic strings/numbers)
- Timezone-safe date handling (T12:00:00 pattern)

**Component Reuse Examples**:
- `MetricsCards`: Shared by Electricity and Water modules
- `OverallTrendChart`: Shared by all modules
- `ForecastChart`: Shared by Electricity, Water, Thermal forecasts
- `TimeFilter`: Shared by Electricity and Water modules

---

## 7. Key Technical Decisions

### 7.1 Timezone Handling Strategy (Defensive Programming)

**Context**:
- Database stores all timestamps in Calgary local time (MST/MDT, UTC-7/-6)
- Application designed to run in Calgary timezone
- No timezone information in database timestamps

**Challenge**:
Different browsers may interpret date strings differently:
- Some browsers: `new Date('2020-11-08')` → `2020-11-08 00:00:00 MST`
- Other browsers: `new Date('2020-11-08')` → `2020-11-08 00:00:00 UTC` → `2020-11-07 17:00:00 MST` (previous day!)

**Solution**:
Add `T12:00:00` (noon time) when creating Date objects:

```javascript
// ❌ RISKY - May cause date shift in some browsers
const date = new Date('2020-11-08');

// ✅ SAFE - Noon time prevents date boundary crossing
const date = new Date('2020-11-08T12:00:00');
```

**Why Noon Time?**
- Even if browser applies timezone conversion, noon time won't cross date boundaries
- Calgary is UTC-7, worst case: `2020-11-08 12:00:00 UTC` → `2020-11-08 05:00:00 MST` (still same day)

**Implementation Locations**:
- Frontend date formatting: `ElectricityReportService.js`, `WaterReportService.js`, `useThermalData.js`
- Frontend date pickers: `ElectricityReportPage.jsx`, `WaterReportPage.jsx`, `ThermalPage.jsx`
- Backend date validation: `electricityController.js`, `waterController.js` (uses string comparison)

**Key Principle**:
Always use **local time methods** (`getFullYear()`, `getMonth()`, `getDate()`) instead of UTC methods, since database times are local Calgary time.

### 7.2 Why Session Instead of JWT?

**Decision**: Use simple sessionStorage instead of JWT tokens

**Rationale**:
- Prototype phase prioritizes functionality over security
- Faster development without token management complexity
- Sufficient for development and demonstration
- JWT and Firebase will be implemented in final phase
- Focus resources on core business features first

**Future Plan**: Implement JWT + Firebase authentication in final phase

### 7.3 Why No Model Classes?

**Decision**: Use functional programming with Hooks and Services instead of OOP classes

**Rationale**:
- React ecosystem strongly favors functional components and Hooks
- Hooks provide better code reusability and composition
- Service layer pattern is cleaner for API calls
- Easier to test and maintain
- Class diagram serves as design reference, not implementation mandate

**Actual Pattern**:
- Custom Hooks for state logic (useAuth, useThermalData, etc.)
- Service classes for API calls (UserService, ElectricityService, etc.)
- Functional components for UI
- Context API for global state

### 7.4 Why Implement Thermal Dashboard Early?

**Decision**: Fully implement Thermal Dashboard (P2) before Electricity Dashboard (P1)

**Rationale**:
- Needed a pilot module for SQL Server integration
- Thermal data structure was ready and available
- Could validate database connection approach
- Lessons learned applied to future modules
- Demonstrates full-stack capability early

**Result**: Successful SQL Server integration, reusable patterns established

### 7.5 Net Energy Calculation Strategy

**Problem**: TL339 (Net Energy) database values are inaccurate

**Solution**: Frontend calculates Net Energy
- Formula: `Net Energy = TL340 (Generation) + TL341 (Consumption)`
- Note: Consumption values are negative in database
- Self-Sufficiency Rate: `(Generation / |Consumption|) × 100%`
- Uses timestamp matching to ensure data alignment

**Implementation Locations**:
- `utils/electricityCalculations.js`: `calculateNetEnergyFromData()`
- `useOverviewData.js`: Overview dashboard data loading
- `NetEnergyWithSelfSufficiencyChart.jsx`: Chart display

---

## 8. Pending Features

### 8.1 Priority 1 (Next Steps)

**User Management Migration to SQL Server**:
- Migrate from Mock JSON to SQL Server
- Implement password hashing (bcrypt)
- Add JWT token authentication
- Timeline: Next sprint

### 8.2 Priority 2 (Future Enhancements)

| Feature | Status | Notes |
|---------|--------|-------|
| 3D Thermal Visualization | Not Started | Requires Three.js integration |
| AI Chatbot (EVA) | Not Started | Requires Google Gemini API integration |
| Quiz System | Not Started | Requires QR code generation |
| Dashboard Management | Not Started | Admin configuration interface |
| Period Comparison (YoY/PoP) | Not Started | Requires historical data analysis |

---

## 9. Known Limitations and Technical Debt

### 9.1 Current Limitations

1. **Authentication Security**:
   - Plain text password storage (Users still in Mock JSON)
   - No password reset functionality
   - No email verification
   - Session-based only (no token refresh)

2. **Data Persistence**:
   - User Management uses Mock JSON (not scalable)
   - Custom Calculator data not persisted
   - Login logs in JSON (should be in database)

3. **Error Handling**:
   - Basic error messages
   - No centralized error logging
   - Limited user feedback on failures

4. **Testing**:
   - No unit tests
   - No integration tests
   - No E2E tests
   - Manual testing only

5. **Performance**:
   - No data pagination
   - No lazy loading for large datasets
   - Limited caching strategy (only Electricity Maps API)

### 9.2 Technical Debt

1. **Code Organization**:
   - Some components exceed 150 lines
   - Duplicate code in export functionality
   - Inconsistent error handling patterns

2. **Documentation**:
   - Limited inline code comments
   - No API documentation (Swagger/OpenAPI)
   - No component documentation (Storybook)

3. **Configuration**:
   - Hardcoded API URLs in some places
   - Environment variables not fully utilized
   - No configuration validation

4. **Accessibility**:
   - Limited ARIA labels
   - No keyboard navigation testing
   - No screen reader testing

---

## 10. Reference Documents

### 10.1 Planning Documents
- **Project Introduction**: `1.EcoSphereIntroduction.md` - Full project background, requirements, and 15-week timeline
- **Implementation Plan**: `2.IMPLEMENTATION_PLAN-cn.md` - Detailed implementation plan with class definitions and API design
- **Architecture Design**: `3.ARCHITECTURE-cn.md` - Original architecture design and technical decisions
- **Historical State**: `4.CURRENT_STATE.md` - Detailed evolution history (1500+ lines)
- **Current State**: `5.CURRENT_STATE_2026-01-EN.md` - This document

### 10.2 Database Analysis Documents
- **Electricity Tables Analysis (English)**: `electricity/ELECTRICITY_TABLES_ANALYSIS_EN.md` - Comprehensive analysis of 21 electricity database tables
- **Electricity Tables Analysis (Chinese)**: `electricity/ELECTRICITY_TABLES_ANALYSIS_CN.md` - Chinese version of electricity database analysis

### 10.3 Key Configuration Files
- **Database Configuration**: `ecosphere-backend/config/database.js`
  - Centralized database constants (table names, query parameters, time constants)
  - sqlcmd path detection and command building
  - Eliminates magic strings/numbers throughout codebase
  - Single source of truth for all database-related configuration

- **Environment Variables**: `ecosphere-backend/.env`
  - `DB_SERVER=.\SQLEXPRESS` (SQL Server instance)
  - `DB_DATABASE=TestSlimDB`
  - Windows Authentication (no credentials needed)
  - Electricity Maps API key
  - Open-Meteo API configuration

### 10.4 Code Locations
- Frontend: `ecosphere-frontend/src/`
- Backend: `ecosphere-backend/`
- Mock Data: `ecosphere-backend/data/` (only users.json and loginLogs.json)
- Documentation: `.documentation/`

---

## 11. Quick Reference

### 11.1 Starting the Project

```bash
# Backend
cd ecosphere-backend
npm install
npm start  # Runs on http://localhost:3001

# Frontend
cd ecosphere-frontend
npm install
npm run dev  # Runs on http://localhost:5173
```

### 11.2 Testing Database Connection

```bash
# Test with sqlcmd (ODBC Driver 18)
sqlcmd -S .\SQLEXPRESS -E -d TestSlimDB -C -Q "SELECT TOP 5 * FROM SaitSolarLab_20004_TL2"

# Test API endpoint
curl http://localhost:3001/api/thermal/single-day?floor=basement&date=2020-11-07
```

### 11.3 Common API Endpoints

```
# Health Check (includes cache, rate limiter, database status)
GET /api/health

# User Authentication
POST /api/users/authenticate

# Electricity Data
GET /api/electricity/consumption?dateFrom=2020-11-01&dateTo=2020-11-08
GET /api/electricity/generation?dateFrom=2020-11-01&dateTo=2020-11-08

# Water Data
GET /api/water/rainwater?dateFrom=2020-11-01&dateTo=2020-11-08
GET /api/water/hot-water?dateFrom=2020-11-01&dateTo=2020-11-08

# Thermal Data
GET /api/thermal/single-day?floor=basement&date=2020-11-07
GET /api/thermal/multiple-days?floor=basement&dateFrom=2020-11-01&dateTo=2020-11-08

# Forecast (Rate Limited)
POST /api/forecast/consumption
POST /api/forecast/generation
POST /api/forecast/hot-water
POST /api/forecast/rainwater
POST /api/forecast/thermal

# Weather Data
GET /api/weather/historical?dateFrom=2020-11-01&dateTo=2020-11-08&type=generation
GET /api/weather/forecast?dateFrom=2026-01-08&dateTo=2026-01-15&type=generation

# Load Testing
node test-load.js  # Simulate 50 concurrent users
```

### 11.4 Code Statistics

**Frontend**:
- Pages: 8 (Login, UserManagement, CarbonFootprint, Electricity, Water, Thermal, Overview, ComingSoon)
- Services: 10
- Custom Hooks: 10+
- Components: 50+

**Backend**:
- Routes: 9
- Controllers: 8
- Services: 7
- Utils: 8

---

## Document Maintenance

**How to Update This Document**:
1. Update after completing each major feature
2. Update when making architectural changes
3. Update when deviating from original plan
4. Keep "Document Version" date current
5. Maintain accuracy - only document what actually exists

**Document History**:
- `4.CURRENT_STATE.md`: Detailed evolution history (Dec 2025 - Jan 2026)
- `5.CURRENT_STATE_2026-01-EN.md`: Current concise version (this document)

---

**End of Document**
