# EcoSphere 项目现状文档

**文档版本**: 2026-01-07  
**项目阶段**: Phase 3 - 小型系统原型  
**目标读者**: 开发团队和 AI 助手  
**历史文档**: 详细演进过程请参考 `4.CURRENT_STATE.md`

---

## 1. 项目概览

**项目名称**: EcoSphere - 智能建筑分析系统  
**客户**: SAIT GBTAC (Green Building Technology Access Centre)  
**开发周期**: 15周 (2026-01-06 至 2026-04-17)  
**当前进度**: P0 100% | P1 100% | P2 90%

### 1.1 核心功能状态

| 模块 | 状态 | 完成度 | 数据源 |
|------|------|--------|--------|
| 登录系统 | ✅ 完成 | 100% | Mock JSON |
| 用户管理 | ✅ 完成 | 100% | Mock JSON |
| 碳足迹追踪 | ✅ 完成 | 100% | SQL Server + API |
| 电力仪表板 | ✅ 完成 | 100% | SQL Server |
| 水资源仪表板 | ✅ 完成 | 100% | SQL Server |
| 热力仪表板 | ✅ 完成 | 100% | SQL Server |
| 总览仪表板 | ✅ 完成 | 100% | SQL Server |
| 预测功能 | ✅ 完成 | 90% | SQL Server + API |
| 3D可视化 | ⏳ 未开始 | 0% | - |
| AI聊天机器人 | ⏳ 未开始 | 0% | - |
| 测验系统 | ⏳ 未开始 | 0% | - |

---

## 2. 技术栈

### 2.1 前端技术
- **框架**: React 19.2.0
- **构建工具**: Vite 7.2.4
- **UI库**: Material-UI 7.3.5
- **路由**: React Router 7.9.6
- **图表**: Chart.js 4.5.1 + react-chartjs-2 5.3.1
- **日期处理**: date-fns 4.1.0
- **PDF导出**: jsPDF 3.0.4 + html2canvas 1.4.1

### 2.2 后端技术
- **运行环境**: Node.js
- **框架**: Express 5.1.0
- **数据库**: SQL Server Express (TestSlimDB)
- **数据库工具**: sqlcmd (命令行查询)
- **时间序列分析**: timeseries-analysis 1.0.12
- **其他**: cors 2.8.5, dotenv 17.2.3, body-parser 2.2.1

### 2.3 外部API集成
- **Electricity Maps API**: 历史碳强度数据 (Alberta, CA-AB)
- **Open-Meteo API**: 天气数据（历史和预测）
  - 用于发电量预测（太阳辐射）
  - 用于雨水预测（降水量）
  - 用于热力预测（室外温度）

---

## 3. 数据库配置

### 3.1 SQL Server 连接信息
```
服务器: .\SQLEXPRESS
数据库: TestSlimDB
认证方式: Windows Authentication
数据库位置: C:\XW\SAIT\GB\
- TestSlimDB.mdf (主数据文件)
- TestSlimDB_log.ldf (日志文件)
```

### 3.2 数据表概览

#### 电力模块数据表
| 表名 | 用途 | 数据范围 | 间隔 |
|------|------|----------|------|
| TL341 | 消耗量（小时增量） | 2019-02-13 至 2020-11-08 | 1小时 |
| TL340 | 发电量（小时增量） | 2019-02-13 至 2020-11-08 | 1小时 |
| TL339 | 净能量（小时增量）⚠️ | 2019-02-13 至 2020-11-08 | 1小时 |
| TL342 | 三相总功率 | 2020-11-01 至 2020-11-08 | 1分钟 |
| TL343 | A相功率 | 2020-11-01 至 2020-11-08 | 1分钟 |
| TL344 | B相功率 | 2020-11-01 至 2020-11-08 | 1分钟 |
| TL345 | C相功率 | 2020-11-01 至 2020-11-08 | 1分钟 |
| TL213 | Panel2A-1设备 | 2020-02-15 至 2020-11-08 | 1分钟 |
| TL4 | 通风设备 | 2020-11-01 至 2020-11-08 | 1分钟 |
| TL209 | 照明设备 | 2019-11-07 至 2019-11-14 | 1分钟 |
| TL211 | 设备用电 | 2019-11-07 至 2019-11-14 | 1分钟 |
| TL212 | 电器用电 | 2019-11-07 至 2019-11-14 | 1分钟 |
| TL252 | 太阳能-车棚 | 2020-11-01 至 2020-11-08 | 1分钟 |
| TL253 | 太阳能-屋顶 | 2020-11-01 至 2020-11-08 | 1分钟 |

**⚠️ 重要说明**: TL339（净能量）数据不准确，系统使用前端计算：`净能量 = TL340（发电） + TL341（消耗）`

#### 水资源模块数据表
| 表名 | 用途 | 数据范围 | 间隔 |
|------|------|----------|------|
| TL93 | 雨水收集水位 (%) | 2018-10-13 至 2020-11-08 | 10分钟 |
| TL210 | 热水消耗 (L/h) | 2018-09-11 至 2019-11-14 | 1分钟 |

#### 热力模块数据表
| 传感器ID | 位置 | 数据范围 | 间隔 |
|----------|------|----------|------|
| 20004_TL2 | 地下室 | 2019-01-01 至 2020-11-08 | 15分钟 |
| 20005_TL2 | 地下室 | 2019-01-01 至 2020-11-08 | 15分钟 |
| 20006_TL2 | 地下室 | 2019-01-01 至 2020-11-08 | 15分钟 |
| 20007_TL2 | 一层 | 2019-01-01 至 2020-11-08 | 15分钟 |
| 20008_TL2 | 一层 | 2019-01-01 至 2020-11-08 | 15分钟 |
| 20009_TL2 | 一层 | 2019-01-01 至 2020-11-08 | 15分钟 |
| 20010_TL2 | 一层 | 2019-01-01 至 2020-11-08 | 15分钟 |
| 20011_TL2 | 一层 | 2019-01-01 至 2020-11-08 | 15分钟 |
| 20012_TL2 | 二层 | 2019-01-01 至 2020-11-08 | 15分钟 |
| 20013_TL2 | 二层 | 2019-01-01 至 2020-11-08 | 15分钟 |
| 20014_TL2 | 二层 | 2019-01-01 至 2020-11-08 | 15分钟 |
| 20015_TL2 | 二层 | 2019-01-01 至 2020-11-08 | 15分钟 |
| 20016_TL2 | 二层 | 2019-01-01 至 2020-11-08 | 15分钟 |

**楼层传感器分布**:
- 地下室: 3个传感器 (20004-20006)
- 一层: 5个传感器 (20007-20011)
- 二层: 5个传感器 (20012-20016)

---

## 4. 核心功能详解

### 4.1 登录与用户管理

**认证方式**: Session-based (使用 sessionStorage)  
**会话超时**: 30分钟自动登出  
**数据源**: Mock JSON (`data/users.json`, `data/loginLogs.json`)

**测试账号**:
```
Super Admin: super.admin@edu.sait.ca / abcd1234
Admin: xujun.wang@edu.sait.ca / abcd1234
Team Member: test.member@edu.sait.ca / abcd1234
```

**用户角色**:
- SuperAdmin: 完全权限，不可删除
- Admin: 管理权限
- TeamMember: 查看权限

**权限类型**:
- electricity (电力)
- water (水资源)
- thermal (热力)
- 3d-model (3D模型)
- carbon-footprint (碳足迹)

**关键文件**:
- 前端: `LoginPage.jsx`, `AuthContext.jsx`, `UserManagementPage.jsx`
- 后端: `userRoutes.js`, `userController.js`, `userService.js`
- 服务: `LoginLogService.js`

### 4.2 碳足迹追踪模块

**两种计算模式**:

#### 模式1: 自动计算（从数据库）
- 数据源: TL341（消耗量）+ Electricity Maps API（碳强度）
- 时间预设: 今天、昨天、最近7天、最近30天、自定义
- 演示日期基准: 2020年11月（数据库可用数据范围）
- 显示逻辑:
  - 单日: 24小时数据点
  - 多日: 每日聚合数据点
- 碳强度: 每日使用对应日期的历史碳强度值
- 计算公式: `CO2 = 能耗(kWh) × 碳强度(kg CO2/kWh)`

#### 模式2: 自定义计算器（用户上传）
- 用户输入电费账单（年、月、用量）
- 实时计算，不持久化
- 使用平均碳强度（从历史数据）
- 数据验证（无重复、无未来日期）

**可视化**:
- Chart.js 折线图（能耗+碳排放双Y轴）
- 指标卡片（总量、平均值）
- 交互式工具提示
- PDF导出功能

**关键文件**:
- 前端: `CarbonFootprintPage.jsx`, `AutomaticCalculationView.jsx`, `CustomCalculator.jsx`
- 后端: `electricityRoutes.js`, `electricityController.js`
- 服务: `ElectricityReportService.js`, `ElectricityMapsService.js`

---

### 4.3 电力仪表板

**四个主要标签页**:

#### 1. 消耗 (Consumption)
- 总体趋势图（小时数据）
- 关键指标：总量、平均、峰值、最小值
- 分解视图:
  - 总体
  - 按相位（A/B/C三相）
  - 按设备（Panel2A-1、通风、照明、设备、电器）

#### 2. 发电 (Generation)
- 总体趋势图（小时数据）
- 关键指标：总量、平均、峰值、最小值
- 分解视图:
  - 总体
  - 按太阳能来源（车棚 vs 屋顶）饼图

#### 3. 净能量 (Net Energy)
- 趋势图（保留正负值）
- 关键指标（红色=负值，绿色=正值）
- 状态指示器（净消费者 vs 净生产者）
- **自给率分析** (2026-01-07新增):
  - 平均自给率指标卡
  - 双Y轴图表：净能量 + 自给率趋势
  - 100%参考线
  - 公式: `自给率 = (发电量 / |消耗量|) × 100%`
  - ⚠️ 前端计算（不使用TL339数据库值）

#### 4. 预测 (Forecast)
- **消耗预测**: 四层算法系统
  - Tier 1: Holt-Winters季节平滑（90%置信度）
  - Tier 2: 季节加权预测（80%置信度）
  - Tier 3: 趋势预测（65%置信度）
  - Tier 4: 移动平均（50%置信度）
- **发电预测**: 天气线性回归模型
  - 公式: `发电量 = a × 直接辐射 + b`
  - 训练数据: 60天历史数据
  - 天气变量: 直接辐射（相关性0.80）
- 预测周期: 7/14/30天
- 数据可用性分析
- 算法可视化网格

**性能优化**:
- 小时聚合（一致的时间间隔）
- 优化SQL查询（DATEPART，270倍性能提升）
- 自动加载数据

**关键文件**:
- 前端页面: `ElectricityReportPage.jsx`
- 前端组件: `ConsumptionTab.jsx`, `GenerationTab.jsx`, `NetEnergyTab.jsx`, `ForecastTab.jsx`
- 共享组件: `MetricsCards.jsx`, `OverallTrendChart.jsx`, `NetEnergyWithSelfSufficiencyChart.jsx`
- 后端: `electricityRoutes.js`, `electricityController.js`, `forecastController.js`
- 工具: `electricityCalculations.js`（净能量和自给率计算）

---

### 4.4 水资源仪表板

**两个主要标签页**:

#### 1. 雨水收集 (Rainwater Harvesting)
- **概览子标签**:
  - 水位监测（%）
  - 历史数据可视化
  - 关键指标：当前值、平均、峰值、最小值
- **预测子标签** (2026-01-06新增):
  - 天气线性回归模型
  - 公式: `日均水位 = a × 降水量 + b`
  - 训练数据: 60天历史数据
  - 预测周期: 7/14/30天
  - 输出: 日均水位（%）

#### 2. 热水消耗 (Hot Water Consumption)
- **概览子标签**:
  - 热水使用量（L/h）
  - 历史数据可视化
  - 关键指标：总量、平均、峰值、最小值
- **预测子标签**:
  - 四层算法系统（同电力消耗预测）
  - 预测周期: 7/14/30天

**时间过滤器**:
- 预设: 最近7/30/90天
- 自定义日期范围

**关键文件**:
- 前端: `WaterReportPage.jsx`, `RainwaterTab.jsx`, `HotWaterTab.jsx`
- 前端预测: `RainwaterForecastView.jsx`, `HotWaterForecastView.jsx`
- 后端: `waterRoutes.js`, `waterController.js`, `forecastController.js`
- 服务: `WaterReportService.js`, `weatherService.js`

---

### 4.5 热力仪表板

**三种视图模式**:

#### 1. 单日视图
- 选定日期的小时数据
- 室外温度叠加（水平线）
- 时间滑块（96个15分钟间隔）
- 播放/暂停动画

#### 2. 多日视图
- 日期范围的聚合数据
- 室外温度叠加（高-低范围阴影）
- 多日滑块

#### 3. 预测视图 (2026-01-07新增)
- **混合模型**: 80%历史基线 + 20%天气调整
- 训练数据: 60天历史数据
- 天气集成: Open-Meteo API室外温度预测
- 多传感器聚合: 每层平均所有传感器
- 预测周期: 7/14/30天
- 公式: `室内温度 = 历史基线 + (天气系数 × 室外温度变化)`

**楼层选择**: 地下室、一层、二层

**楼层平面图热力图**:
- 实时温度叠加
- 8级颜色编码（< 0°C 至 > 35°C）
- 多传感器支持（每层3-5个）
- 室外温度显示（左下角，每15分钟更新）

**温度颜色编码**:
- < 0°C: 黑色（冰冻）
- 0-20°C: 蓝色（寒冷）
- 20-22°C: 浅蓝（凉爽）
- 22-23°C: 绿色（舒适）
- 23-24°C: 黄色（温暖）
- 24-25°C: 橙色（炎热）
- 25-35°C: 红色（很热）
- > 35°C: 紫色（极热）

**关键文件**:
- 前端: `ThermalPage.jsx`, `ThermalControlPanel.jsx`, `ThermalFloorPlan.jsx`
- 前端预测: `ThermalForecastView.jsx`, `ThermalForecastInfo.jsx`
- 后端: `thermalRoutes.js`, `thermalController.js`, `forecastController.js`
- 服务: `ThermalService.js`, `WeatherService.js`

---

### 4.6 总览仪表板 (2026-01-07增强)

**统一视图**: 单页显示所有三个模块

**时间预设**:
- 演示日: 2020-11-01 至 2020-11-08（8天）
- 今天、昨天、最近7天
- 无自定义日期选择器（需要自定义请访问具体模块页面）

**模块显示**:

#### 电力模块
- 双列卡片布局（消耗、发电）+ 全宽净能量卡片
- 复用组件: `MetricsCards`, `NetEnergyMetricsCards`, `OverallTrendChart`, `NetEnergyWithSelfSufficiencyChart`
- 显示自给率（双Y轴图表）
- 计算净能量（不使用数据库值）

#### 水资源模块
- 双列卡片布局（雨水、热水）
- 复用组件: `MetricsCards`, `OverallTrendChart`
- 与电力模块一致的样式

#### 热力模块
- 双列布局（地下室、一层）+ 全宽二层卡片
- 自定义温度统计（平均、最大、最小）
- 固定Y轴范围（15°C - 30°C）便于比较

**数据聚合**:
- 电力: 前端计算净能量和自给率（时间戳匹配）
- 水资源: 单传感器（TL93雨水，TL210热水）
- 热力: 多传感器平均（每层所有传感器）

**紧凑设计**:
- 减小字体和间距
- 图表高度: 180px（消耗/发电/水资源），220px（净能量）
- 无图表下方空白
- 一致的卡片内边距

**关键文件**:
- 前端: `OverviewPage.jsx`
- 组件: `ElectricityOverview.jsx`, `WaterOverview.jsx`, `ThermalOverview.jsx`
- 钩子: `useOverviewData.js`（增强净能量计算）
- 工具: `dataAggregation.js`, `electricityCalculations.js`

---

## 5. 项目架构

### 5.1 前端架构

**模式**: 函数式组件 + 自定义Hooks + 服务层

```
src/
├── components/          # UI组件
│   ├── CarbonFootprint/ # 碳足迹组件
│   ├── Electricity/     # 电力组件
│   ├── Water/           # 水资源组件
│   ├── Thermal/         # 热力组件
│   ├── Forecast/        # 预测组件（共享）
│   ├── Overview/        # 总览组件
│   ├── Common/          # 可复用组件
│   └── Layout/          # 布局组件
├── pages/               # 页面容器
├── contexts/            # 全局状态（AuthContext）
├── hooks/               # 自定义Hooks
├── services/            # API通信层
├── lib/                 # 工具和常量
│   ├── constants/       # 常量定义
│   ├── hooks/           # 领域特定Hooks
│   └── utils/           # 工具函数
└── App.jsx              # 主路由
```

**关键模式**:
- 容器/展示组件分离
- 自定义Hooks处理复杂状态逻辑
- 服务层处理所有API调用
- Context API管理认证状态
- 基于角色的路由保护

### 5.2 后端架构

**模式**: 路由 → 控制器 → 服务 → 数据

```
ecosphere-backend/
├── routes/              # API端点定义
│   ├── userRoutes.js
│   ├── electricityRoutes.js
│   ├── waterRoutes.js
│   ├── thermalRoutes.js
│   ├── forecastRoutes.js
│   ├── weatherRoutes.js
│   └── loginLogRoutes.js
├── controllers/         # 请求处理和响应
├── services/            # 业务逻辑和数据操作
├── db/                  # 数据库工具
│   └── sqlcmdQuery.js   # SQL Server查询助手
├── config/              # 配置
│   ├── database.js      # 数据库配置（集中化）
│   └── config.js        # 环境配置
├── utils/               # 工具函数
│   ├── controllerHelper.js    # 控制器助手
│   ├── validationHelper.js    # 验证助手
│   ├── responseHelper.js      # 响应助手
│   ├── forecastHelpers.js     # 预测助手
│   ├── thermalConstants.js    # 热力常量
│   ├── forecastConstants.js   # 预测常量
│   └── weatherConstants.js    # 天气常量
├── data/                # Mock数据
│   ├── users.json
│   └── loginLogs.json
└── server.js            # Express服务器入口
```

**关键模式**:
- RESTful API设计
- 分层架构（关注点分离）
- 集中化配置（database.js消除魔法字符串/数字）
- 集中化错误处理
- CORS配置（Vercel部署）
- 基于环境的配置

### 5.3 数据流

```
用户操作（前端）
    ↓
UI组件（React）
    ↓
自定义Hook（如果有复杂状态）
    ↓
服务层（API调用）
    ↓
HTTP请求（fetch）
    ↓
后端路由
    ↓
控制器（请求验证）
    ↓
服务（业务逻辑）
    ↓
数据源（Mock JSON 或 SQL Server）
    ↓
响应（JSON）
    ↓
服务层（前端）
    ↓
状态更新（Hook 或 Context）
    ↓
UI重新渲染
```

---

## 6. 代码标准和最佳实践

### 6.1 后端代码标准 (2026-01-05建立)

**核心原则**:
1. **无魔法数字/字符串**: 所有常量集中在配置文件
2. **DRY原则**: 提取通用模式到可复用工具
3. **一致的错误处理**: 使用助手函数处理try-catch
4. **输入验证**: 处理前验证所有用户输入
5. **声明式/配置驱动**: 优先配置而非命令式代码
6. **代码大小限制**: 控制器 < 150行，函数 < 50行

**重构成果**:
- Electricity Controller: 305行 → 147行（减少52%）
- Water Controller: 105行 → 66行（减少37%）
- Thermal Controller: 155行 → 139行（减少10%）

**新工具文件**:
- `utils/controllerHelper.js`: asyncHandler, createDataFetcher, createBreakdownDataFetcher
- `utils/validationHelper.js`: validateParams
- `utils/responseHelper.js`: sendSuccess, sendError
- `utils/thermalConstants.js`: 热力特定常量
- `utils/thermalValidation.js`: 热力验证函数
- `utils/weatherConstants.js`: 天气API配置

### 6.2 前端代码标准

**企业React标准**:
- 组件 < 150行
- Hooks在顶部
- 组件可复用性
- 集中化常量（无魔法字符串/数字）
- 时区安全的日期处理（T12:00:00模式）

**组件复用示例**:
- `MetricsCards`: 电力和水资源模块共享
- `OverallTrendChart`: 所有模块共享
- `ForecastChart`: 电力、水资源、热力预测共享
- `TimeFilter`: 电力和水资源共享

---

## 7. 关键技术决策

### 7.1 时区处理策略（防御性编程）

**背景**:
- 数据库存储所有时间戳为卡尔加里本地时间（MST/MDT，UTC-7/-6）
- 应用设计为在卡尔加里时区运行
- 数据库时间戳中无时区信息

**挑战**:
不同浏览器可能对日期字符串解释不同：
- 某些浏览器: `new Date('2020-11-08')` → `2020-11-08 00:00:00 MST`
- 其他浏览器: `new Date('2020-11-08')` → `2020-11-08 00:00:00 UTC` → `2020-11-07 17:00:00 MST`（前一天！）

**解决方案**:
添加 `T12:00:00`（中午时间）创建Date对象：

```javascript
// ❌ 有风险 - 某些浏览器可能导致日期偏移
const date = new Date('2020-11-08');

// ✅ 安全 - 中午时间防止日期边界跨越
const date = new Date('2020-11-08T12:00:00');
```

**为什么用中午时间？**
- 即使浏览器应用时区转换，中午时间也不会跨越日期边界
- 卡尔加里是UTC-7，最坏情况：`2020-11-08 12:00:00 UTC` → `2020-11-08 05:00:00 MST`（仍是同一天）

**实施位置**:
- 前端日期格式化: `ElectricityReportService.js`, `WaterReportService.js`, `useThermalData.js`
- 前端日期选择器: `ElectricityReportPage.jsx`, `WaterReportPage.jsx`, `ThermalPage.jsx`
- 后端日期验证: `electricityController.js`, `waterController.js`（使用字符串比较）

**关键原则**:
始终使用**本地时间方法**（`getFullYear()`, `getMonth()`, `getDate()`）而非UTC方法，因为数据库时间是本地卡尔加里时间。

### 7.2 为什么使用Session而非JWT？

**决策**: 使用简单的sessionStorage而非JWT令牌

**理由**:
- 原型阶段优先功能而非安全性
- 更快开发，无令牌管理复杂性
- 足够用于开发和演示
- JWT和Firebase将在最终阶段实施
- 优先资源投入核心业务功能

**未来计划**: 最终阶段实施JWT + Firebase认证

### 7.3 为什么不使用Model类？

**决策**: 使用函数式编程配合Hooks和Services，而非OOP类

**理由**:
- React生态系统强烈倾向函数式组件和Hooks
- Hooks提供更好的代码复用和组合
- 服务层模式对API调用更清晰
- 更易测试和维护
- 类图作为设计参考，非实施强制

**实际模式**:
- 自定义Hooks处理状态逻辑（useAuth, useThermalData等）
- 服务类处理API调用（UserService, ElectricityService等）
- 函数式组件处理UI
- Context API处理全局状态

### 7.4 为什么提前实施热力仪表板？

**决策**: 完整实施热力仪表板（P2）早于电力仪表板（P1）

**理由**:
- 需要SQL Server集成的试点模块
- 热力数据结构已就绪可用
- 可验证数据库连接方法
- 经验教训应用于未来模块
- 早期展示全栈能力

**结果**: SQL Server集成成功，建立可复用模式

### 7.5 净能量计算策略

**问题**: TL339（净能量）数据库值不准确

**解决方案**: 前端计算净能量
- 公式: `净能量 = TL340（发电） + TL341（消耗）`
- 注意: 消耗量在数据库中为负值
- 自给率: `(发电量 / |消耗量|) × 100%`
- 使用时间戳匹配确保数据对齐

**实施位置**:
- `utils/electricityCalculations.js`: `calculateNetEnergyFromData()`
- `useOverviewData.js`: 总览仪表板数据加载
- `NetEnergyWithSelfSufficiencyChart.jsx`: 图表显示

---

## 8. 待完成功能

### 8.1 优先级1（下一步）

**用户管理迁移到SQL Server**:
- 从Mock JSON迁移到SQL Server
- 实施密码哈希（bcrypt）
- 添加JWT令牌认证
- 时间线: 下一个冲刺

### 8.2 优先级2（未来增强）

| 功能 | 状态 | 说明 |
|------|------|------|
| 3D热力可视化 | 未开始 | 需要Three.js集成 |
| AI聊天机器人（EVA） | 未开始 | 需要Google Gemini API集成 |
| 测验系统 | 未开始 | 需要二维码生成 |
| 仪表板管理 | 未开始 | 管理员配置界面 |
| 周期比较（YoY/PoP） | 未开始 | 需要历史数据分析 |

---

## 9. 已知限制和技术债务

### 9.1 当前限制

1. **认证安全**:
   - 明文密码存储（用户仍在Mock JSON）
   - 无密码重置功能
   - 无邮箱验证
   - 仅基于会话（无令牌刷新）

2. **数据持久化**:
   - 用户管理使用Mock JSON（不可扩展）
   - 自定义计算器数据不持久化
   - 登录日志在JSON中（应在数据库）

3. **错误处理**:
   - 基本错误消息
   - 无集中化错误日志
   - 失败时用户反馈有限

4. **测试**:
   - 无单元测试
   - 无集成测试
   - 无E2E测试
   - 仅手动测试

5. **性能**:
   - 无数据分页
   - 大数据集无懒加载
   - 有限的缓存策略（仅Electricity Maps API）

### 9.2 技术债务

1. **代码组织**:
   - 某些组件超过150行
   - 导出功能中有重复代码
   - 错误处理模式不一致

2. **文档**:
   - 有限的内联代码注释
   - 无API文档（Swagger/OpenAPI）
   - 无组件文档（Storybook）

3. **配置**:
   - 某些地方硬编码API URL
   - 环境变量未充分利用
   - 无配置验证

4. **可访问性**:
   - 有限的ARIA标签
   - 无键盘导航测试
   - 无屏幕阅读器测试

---

## 10. 参考文档

### 10.1 规划文档
- **项目介绍**: `1.EcoSphereIntroduction.md` - 完整项目背景、需求和15周时间线
- **实施计划**: `2.IMPLEMENTATION_PLAN-cn.md` - 详细实施计划，包含类定义和API设计
- **架构设计**: `3.ARCHITECTURE-cn.md` - 原始架构设计和技术决策
- **历史现状**: `4.CURRENT_STATE.md` - 详细演进过程（1500+行）
- **当前现状**: `5.CURRENT_STATE_2026-01.md` - 本文档

### 10.2 数据库分析文档
- **电力表分析（英文）**: `electricity/ELECTRICITY_TABLES_ANALYSIS_EN.md` - 21个电力数据库表的综合分析
- **电力表分析（中文）**: `electricity/ELECTRICITY_TABLES_ANALYSIS_CN.md` - 电力数据库分析中文版

### 10.3 关键配置文件
- **数据库配置**: `ecosphere-backend/config/database.js`
  - 集中化数据库常量（表名、查询参数、时间常量）
  - sqlcmd路径检测和命令构建
  - 消除整个代码库中的魔法字符串/数字
  - 所有数据库相关配置的单一真实来源

- **环境变量**: `ecosphere-backend/.env`
  - `DB_SERVER=.\SQLEXPRESS`（SQL Server实例）
  - `DB_DATABASE=TestSlimDB`
  - Windows认证（无需凭据）
  - Electricity Maps API密钥
  - Open-Meteo API配置

### 10.4 代码位置
- 前端: `ecosphere-frontend/src/`
- 后端: `ecosphere-backend/`
- Mock数据: `ecosphere-backend/data/`（仅users.json和loginLogs.json）
- 文档: `.documentation/`

---

## 11. 快速参考

### 11.1 启动项目

```bash
# 后端
cd ecosphere-backend
npm install
npm start  # 运行在 http://localhost:3001

# 前端
cd ecosphere-frontend
npm install
npm run dev  # 运行在 http://localhost:5173
```

### 11.2 测试数据库连接

```bash
# 使用sqlcmd测试（ODBC Driver 18）
sqlcmd -S .\SQLEXPRESS -E -d TestSlimDB -C -Q "SELECT TOP 5 * FROM SaitSolarLab_20004_TL2"

# 测试API端点
curl http://localhost:3001/api/thermal/single-day?floor=basement&date=2020-11-07
```

### 11.3 常用API端点

```
# 用户认证
POST /api/users/authenticate

# 电力数据
GET /api/electricity/consumption?dateFrom=2020-11-01&dateTo=2020-11-08
GET /api/electricity/generation?dateFrom=2020-11-01&dateTo=2020-11-08

# 水资源数据
GET /api/water/rainwater?dateFrom=2020-11-01&dateTo=2020-11-08
GET /api/water/hot-water?dateFrom=2020-11-01&dateTo=2020-11-08

# 热力数据
GET /api/thermal/single-day?floor=basement&date=2020-11-07
GET /api/thermal/multiple-days?floor=basement&dateFrom=2020-11-01&dateTo=2020-11-08

# 预测
POST /api/forecast/consumption
POST /api/forecast/generation
POST /api/forecast/hot-water
POST /api/forecast/rainwater
POST /api/forecast/thermal

# 天气数据
GET /api/weather/historical?dateFrom=2020-11-01&dateTo=2020-11-08&type=generation
GET /api/weather/forecast?dateFrom=2026-01-08&dateTo=2026-01-15&type=generation
```

### 11.4 代码统计

**前端**:
- 页面: 8个（Login, UserManagement, CarbonFootprint, Electricity, Water, Thermal, Overview, ComingSoon）
- 服务: 10个
- 自定义Hooks: 10+个
- 组件: 50+个

**后端**:
- 路由: 9个
- 控制器: 8个
- 服务: 7个
- 工具: 8个

---

## 文档维护

**如何更新本文档**:
1. 完成每个主要功能后更新
2. 进行架构更改时更新
3. 偏离原始计划时更新
4. 保持"文档版本"日期最新
5. 保持准确性 - 仅记录实际存在的内容

**文档历史**:
- `4.CURRENT_STATE.md`: 详细演进历史（2025-12至2026-01）
- `5.CURRENT_STATE_2026-01.md`: 当前简洁版本（本文档）

---

**文档结束**
